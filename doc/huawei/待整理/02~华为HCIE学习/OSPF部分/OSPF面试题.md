# 第一章：基础理论部分

基础部分面试官主要是问一些简单得原理，口头描述的东西。不会涉及到报文的参数属性等。

## OSPF是什么

定义也就是区别，链路状态协议和距离矢量协议的区别

开放式==最短路径==优先协议
==路由是以自己为根，根据数据库计算去往所有树枝节点的最佳路径放进自己的路由表==

##  描述OSPF 工作流程

1. 交互hello:路由器向每一个启用OSPF 进程的接口发送hello接收邻居发送过来的hello,并且匹配hello中的各种参数, 如果参数匹配, 就进行下一步, 建立邻居关系。

2. 邻居/邻接:接口根据OSPF 网络类型建立邻居或者邻接的关系, 邻居关系就是只交互过hello报文,并不知道邻居具体的物理拓扑信息.邻接关系就是两个邻居之间完全交互过各种报文, 两台路由器拥有各自的明细拓扑信息LSDB 完全同步。

3. 发送LSA:路由器根据与对方建立的邻居或邻接关系向邻居发送不同类型的LSA,这些LSA 包含了路由器所有启用了OSPF 进程的链路信息,接口信息,这些信息可以是末梢网络,也可以是去往其他OSPF 区域的传输网络,或者是去往外部自治系统的网络, 根据各种各样的情形设计了不同的LSA。

4. LSA 泛洪:接收邻居发送过来的LSA ,加入LSDB,并且根据路由器自身的角色对邻居发送过来的LSA 进行泛洪发送,以及转换工作。

5. 收敛:当一个区域内的所有路由器的LSDB 完全同步, 网络就完成收敛。

6. 执行SPF计算:一个区域内每个路由器以自身为树根, 计算到达每一个节点的最短路径, 画出一个最短路径的矢量图, 这个拓扑图就是SPF算法树。

7. 计算路由：根据SPF 计算得到的矢量图计算到达每一个节点的最优路径, 放到路由表。

## OSPF邻接关系建立过程中有哪些状态机?

- Down：初始状态，没有在邻居失效时间间隔内收到来自邻居路由器的hello数据包
- Attempt：该状态仅发生在NBMA网络中，对端在邻居失效时间间隔内没有回复hello报文，此时路由器依然轮询hello报文时间间隔向对端发送hello报文
- Init：收到对端发送的hello报文
- 2-Way：收到hello报文中含有自己的Router ID；如果不形成邻接关系，则邻居状态机就停留在此状态，否则进入Exstart状态
- Exstart：如果形成邻居关系，则从Init状态转为Exstart状态，开始协商主从关系，并确定DD序列号
- Exchange 同步数据库
- Loading：DD报文交换完成Exchange done，此时状态为loading
- Full：LSR重传列表为空



## OSPF报文类型

- Hello报文：周期性发送，发现和维持OSPF邻居关系
- DD报文：描述本地LSDB的摘要信息，用于两台设备进行数据库同步
- LSR报文：用于请求对方所需的LSA（只有在OSPF邻居双方成功交换DD报文后才会向对方发出LSR报文）
- LSU报文：用于发送期所需要的LSA
- LSAck报文：用于对收到的LSA进行确认



## Router ID 选举原则



Router ID是一个32位的值，它唯一的标识了一个自治系统内的路由器，可以为每台运行OSPF的路由器上可以手动配置一个RouterID，或者指定一个IP地址作为RouterID。

如果设备存在多个逻辑接口地址，则路由器使用逻辑接口中最大的IP地址作为RouterID，如果没有配置逻辑接口，则路由器使用物理接口的最大IP地址作为RouterID。



## DR与BDR

### DR作用

DR 在多路访问中可以减少邻接关系和 LSA 的泛洪，BDR 是DR的备份。如果设备之间建立全互联的邻接关系， LSA 泛洪和处理占用系统资源和链路资源。如果选举一个DR/BDR ， 所有设备都和DR/BDR 建立full的邻接关系，DRothers 之间停留在Two-way ， DRothers 和DR/BDR 之间交互LSA 就可以了，这样可以减少邻接关系和 LSA 的泛洪。在广播和NBMA 中DR 是一个伪节点，每个设备只要计算到达DR 的开销即可，画路径矢量图的时候会用到。



### DR和BDR选举原理选举原理

比较接口优先级，接口优先级默认为1；如果接口优先级相同在比较RID；数值越大越好；
为了网络稳定，==DR/BDR选举不具有强制性==，即便之后加入接口优先级比DR更高。

### 为什么DR不可以抢占？

因为在MA网络中所有DRothers是和DR建立邻居的，如果新加入的路由器抢占DR位置，会导致其他所有路由器断掉现在的邻居，和新加入的路由器建立邻居，由于需要重新选举DR、建立邻居、传递更新计算路由，会导致短时间的断网现象，会导致网络的不稳定。



## OSPF建立邻接的条件

### 1.报头中要匹配的字段

- 1>版本一致.IPv4 版本的OSPF 和IPv6版本的OSPF 版本报文不兼容
- 2>RID不能冲突.

- 3>一条链路的两端 必须在同一个区域.

- 4>认证类型和密钥.

### 2.hello报文中需要匹配的字段

- 5>掩码需要匹配
- 并不是所有的掩码都需要匹配,当你的网络类型为广播和NBMA的时候,大家要建立邻居,掩码必许要一致。如果网络类型为点到点或点到多点的时候,掩码是不需要一致的。

- 6>hello时间dead时间需要匹配。

- 7>option中的E位和N位必须要一致的。
- 8>Router priority字段,为0 代表该路由器没有资格选举DR/BDR ， 在要求选举DR/BDR 的网络类型中， 必须至少有一个DR 存在，即在这个网络中至少有一个路由器接口路由器优先级不为0。

- 9> NBMA中要对邻居指peer，双方要互指

- 10> 建立邻居的接口不能是静默接口

### 3.DBD 报文需要匹配的字段

- 11>DBD报文中只有一个字段要匹配,就是MTU.如果MTU不匹配,路由器就会卡在exstart状态,因为在这个状态中双方会交互firstDBD选择主从,如果开启MTU一致性检测,只有MTU一致才可以选出主从,思科默认开启这个特性,huawei默认没开。



## OSPF的hello包TTL值为多少

hello包TTL为1



##  OSPF邻居建立过程

- 1.Down，在Down状态下，OSPF进程还没有与任何邻居交换信息。OSPF在等待进入Init状态。

- 1.5>Attempt 尝试。只有在Non-Broadcast非广播和point-to-multipoint non-Broadcast点到多点非广播才能见到尝试。在这2种接口使用OSPF，不会主动发送hello，因为在发送ospf报文的时候，必须只能以单播的形式发送。Cisco需要使用neighbor 华为需要指peer 命令指定单播报文发送的目的地，就是单播指定了一个邻居，已经给他发送了一个单播hello，还没收到任何回应，我的邻居状态就是attempt。这个阶段是临时阶段，最多维持hello时间4倍，没有收到回应就回到down。

- 2>Init 初始化状态，OSPF路由器以固定的时间间隔（缺省10s）发送类型1（Hello）的分组，以便与邻居路由器建立特殊的关系。

- 3>Two-way 双边邻居，每台OSPF路由器都使用分组试图与同一个IP网络中的所有邻居路由器建立双向状态或双向通信。Hello分组中含有发送者已知的OSPF邻居列表。当路由器看到它自己出现在一个邻居路由器的Hello分组中时，它就进入了双向状态。

-  4>Exstart 准启动状态，当路由器与它的邻居进入到ExStart状态后，他们之间的会话就表征为一种毗邻关系，但这时路由器还没有变成全毗邻状态。ExStart状态是使用类型2的数据库描述（DBD，DataBase Description）分组建立的，两个路由器用Hello分组协商在它们之间的关系谁是“主”，谁是“从”（具有最高OSPF路由器ID的路由器将胜出并变成“主”）。

- 5>Exchange 阶段，主路由器带动从路由器交互DBD 报文

- 6>loading：根据交互的DBD 报文可以得知双方需要的LSA 信息， 根据自己没有而邻居有的LSA向邻居请求

- 7>FULL完全邻接状态 ：最终状态，邻接建立完成





## 影响邻居关系建立的因素有哪些？

- Router-ID冲突
- Area ID不一致
- 认证不一致，认证字段放在ospf报文的头部，针对所有报文



## OSPF网络类型

- Point-to-point 点到点类型

- Point-to-multipoint 点到多点类型

- Broadcast 广播类型

- NBMA 非广播多路访问网络

- Virtual-link 虚链路

---



详解：

- 广播类型：链路层协议是Ethernet、FDDI时，通常以组播形式发送hello报文、LSU报文和LSAck报文。单播形式发送DD报文和LSR报文。（224.0.0.5为ospf设备预留的IP组播地址，224.0.0.6为ospfDR/BDR预留的IP组播地址）
- NBMA类型（Non-Broadcast Multi-Acess）：链路层协议是帧中继、X.25，以单播形式发送协议报文

- 点到多点类型：没有一种链路层协议会被认为是点到多点类型，都是由其他完了联系强制更改的。组播（224.0.0.5）形式发送hello报文，单播形式发送其他协议报文。

- 点到点类型：链路层协议为PPP、HDLC、 LAPB，组播（224.0.0.5）形式发送协议报文



## 划分区域好处

划分区域好处；怎么划分区域；划分区域减少了哪些LSA；划分区域需要注意什么？

- 0为骨干区域，其他非0的为普通区域，非骨干区域必须要和骨干区域直连；骨干区域不能分离
- 有些数据库仅在区域内部同步，划分区域减少了区域内部路由器数据库条目，因为LSA-1/2仅在本区域内泛洪；实现了故障隔离，本区域网络故障不会再其他区域路由收敛；方便扩充网络
- 区域是基于链路或者说是基于接口的





## OSPF路由选路的原则

答：选路原则：区域内>区域间>外部路由一类>外部路由二类

**在什么情况下会负载？**

负载条件：1、cost 一致；2、区域一致



## LSA的类型及详细分析(重点)

- LSA-1：每个设备都会产生，描述了设备的链路状态和开销，在所属区域内泛洪
- LSA-2：由DR产生，描述本网段的链路状态，在所属区域内泛洪
- LSA-3：由ABR产生，区域间路由通告。除STUB和NSSA区域，只发布一条缺省路由。
- LSA-4：由ABR产生，描述到ASBR的路由，通告给除ASBR所在区域的其他相关区域。每经过一个ABR路由器都会对这个LSA-4重新产生一次，主要作用是计算这个ABR路由器到ASBR的cost值;也就是说这个LSA-4没经过一个ABR会把Advertising Router ID和cost值重新填写
- LSA-5：由ASBR产生，描述到AS外部的路由，通告到所有区域（除STUB或NSSA区域）
- LSA-7：由ASBR产生，描述到AS外部的路由，仅在NSSA区内泛洪





---





# 第二章：OSPF面试题-中级

## OSPF特殊区域应用场景和特点

- STUB区域：只允许发布区域内路由和区域间路由，允许ABR发布Type3缺省路由

- 完全STUB区域：只允许发布区域内路由，允许ABR发布Type3缺省路由

- NSSA区域：只允许发布区域内路由和区域间路由，允许ABR发布Type3缺省路由到域内。允许自治系统外部路由引入，由ASBR发布Type7 LSA通告给本区域，LSA在ABR上转换成Type5 LSA，并且泛洪到整个ospf域内

- 完全NSSA区域：只允许发布区域内路由，允许ABR发布Type3缺省路由，允许自治系统外部路由引入，由ASBR发布Type7 LSA通告给本区域，LSA在ABR上转换成Type5 LSA，并且泛洪到整个ospf域内



## OSPF 是如何进行防环的？

主要分为：

- 区域内的防环：区域内的防环：LSA1，LSA2：根据 SPF 算法进行防环

- 区域间防环：OSPF 要求所有的非 0 区域必须与骨干区域直接相连， 区域间路由需经由骨干区域中转。

> 解读：OSPF 要求所有的非 0 区域必须与骨干区域直接相 连，区域间路由需经由骨干区域中转。这个要求使 得区域间的路由传递不能发生在两个非 0 的区域之 间，这在很大程度上规避了区域间路由环路的发生， 也使得 OSPF 的区域架构在逻辑上形成了一个类似星型的拓扑。
> ==区域间的水平分割==
>
> 1. 从一个非骨干区域学习到的 LSA3 不会再传回该 非骨干区域（因为 1LSA 优于 3LSA，不是根据区域 ID 判断，主要根据 ABR 的 LSDB 判断）
> 2. 完全意义上的 ABR 从非骨干区域收到的 LSA3 会 接收但是不会参与计算也不会传回非骨干区域（此 规则对非完全意义上的 ABR 无效）
>

- 外部路由防环：

> 1.LSA4：由于 LSA4 类的产生以及泛洪范围与 LSA3 一致，所以 LSA4 的防环 规则与 LSA3 一致。LSA5、7：当 FA 地址为全零，根据 LSA4 类防环；如果 LSA4 无环，那么 LSA5， 7 也无环。
> 2.当 FA 地址为非全零，根据 LSA1-3 类防环；如果 LSA1-3 无环，那么 LSA5，7 也无环。



## 什么情况会卡在2-WAY和ESTART

- 卡在Down的状态：ospf没有运行
- 卡在Init的状态：没有收到对方的Hello报文
- 卡在2-way的状态：MA网络没法选举
- 卡在Exstart状态：MTU不匹配
- 卡在Exchange状态：交互问题有问题，发出DBD后没收到ACK



## 有数据库但是没有路由时候什么原因造成的

网络类型不一样，通过hello包能建立了邻居，不能正确生成链路数据库。

## LSA刷新时间？最大老化时间？

每30分钟会针对LSA重新泛洪一次，老化时间是一个小时

## 虚链路的优缺点

让没有与骨干区域直接相连的区域连接起来 　　　　

## 虚链路不能穿过STUB和NSSA区域

不能



## OSPF认证都有哪些认证方式

区域验证方式
接口验证方式，两者都存在，接口验证方式优先

## OSPF的cost值怎么计算

OSPF的cost：10的八次方/接口带宽,去往目的的出接口累加COST

## OSPF的hello报文包含哪些参数

RID，area-ID，接口地址掩码，认证类型，认证信息，DR，BDR，优先级

## 区域和DR基于路由器还是接口的

基于接口



