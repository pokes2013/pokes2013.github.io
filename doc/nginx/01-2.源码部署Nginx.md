
## 源码部署Nginx

你想要在 CentOS 7 系统上通过源码编译的方式部署 Nginx，这种方式能让你更灵活地定制 Nginx 的功能模块，是生产环境中常用的部署方式。

### 一、部署前准备

首先需要安装编译 Nginx 所需的依赖包，这些包是编译过程中必不可少的：

```bash
# 1. 安装基础编译工具和依赖
yum install -y gcc gcc-c++ make pcre pcre-devel zlib zlib-devel openssl openssl-devel wget

# 2. 创建Nginx运行用户（安全最佳实践）
useradd -M -s /sbin/nologin nginx
```

- `gcc/gcc-c++`: 编译 Nginx 源码的核心编译器
- `pcre/pcre-devel`: 支持正则表达式，Nginx 地址重写依赖
- `zlib/zlib-devel`: 支持数据压缩
- `openssl/openssl-devel`: 支持 HTTPS 协议
- `useradd`: 创建无登录权限的 nginx 用户，避免使用 root 运行 Nginx

### 二、下载并解压 Nginx 源码

```bash
# 1. 切换到临时目录（方便管理）
cd /usr/local/src

# 2. 下载Nginx源码（以稳定版1.24.0为例，可替换为最新稳定版）
wget https://nginx.org/download/nginx-1.24.0.tar.gz

# 3. 解压源码包
tar -zxvf nginx-1.24.0.tar.gz

# 4. 进入解压后的目录
cd nginx-1.24.0
```

如果 `wget` 下载慢，可手动下载源码包上传到 `/usr/local/src` 目录后再解压。

### 三、配置编译参数

这一步是源码编译的核心，通过 `./configure` 定制 Nginx 功能：

```bash
# 配置编译参数（指定安装路径、用户、模块等）
./configure \
--prefix=/usr/local/nginx \          # Nginx安装根目录
--user=nginx \                       # 运行Nginx的用户
--group=nginx \                      # 运行Nginx的用户组
--with-http_ssl_module \             # 启用HTTPS模块
--with-http_v2_module \              # 启用HTTP/2模块
--with-http_gzip_static_module \     # 启用gzip静态压缩模块
--with-http_stub_status_module \     # 启用状态监控模块
--with-stream \                      # 启用TCP/UDP反向代理模块
--pid-path=/var/run/nginx.pid \      # PID文件路径
--error-log-path=/var/log/nginx/error.log \  # 错误日志路径
--http-log-path=/var/log/nginx/access.log   # 访问日志路径
```

参数说明：

- `--prefix`: 定义 Nginx 的安装目录，后续所有路径默认基于此
- `--with-*`: 启用对应的功能模块，按需添加 / 删除
- 日志和 PID 路径建议放到系统标准目录（/var/log、/var/run），方便管理

### 四、编译并安装

```bash
# 1. 编译（-j 后接CPU核心数，加快编译速度，如-j4）
make -j $(grep -c ^processor /proc/cpuinfo)

# 2. 安装
make install
```

编译过程中如果报错，大概率是依赖包未安装完整，回到第一步检查并补充安装。

### 五、配置系统环境和服务

#### 1. 添加 Nginx 命令到系统环境

```bash
# 创建软链接，让系统识别nginx命令
ln -s /usr/local/nginx/sbin/nginx /usr/sbin/

# 验证是否生效
nginx -v  # 输出Nginx版本即成功
```

#### 2. 创建 systemd 服务（方便管理 Nginx 启停）

```bash
# 创建服务文件
cat > /usr/lib/systemd/system/nginx.service << EOF
[Unit]
Description=nginx - high performance web server
Documentation=http://nginx.org/en/docs/
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
PIDFile=/var/run/nginx.pid
ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
ExecReload=/usr/local/nginx/sbin/nginx -s reload
ExecStop=/usr/local/nginx/sbin/nginx -s stop
PrivateTmp=true
User=nginx
Group=nginx

[Install]
WantedBy=multi-user.target
EOF
```

#### 3. 启动并设置开机自启

```bash
# 重新加载systemd配置
systemctl daemon-reload

# 启动Nginx
systemctl start nginx

# 设置开机自启
systemctl enable nginx

# 验证状态
systemctl status nginx  # 显示active (running) 即成功
```

### 六、验证部署

```bash
# 1. 查看端口监听（默认80端口）
netstat -tlnp | grep nginx

# 2. 本地访问测试
curl http://127.0.0.1
# 输出Nginx默认欢迎页的HTML内容即部署成功
```

### 总结

1. **核心步骤**：安装依赖 → 下载源码 → 配置编译参数 → 编译安装 → 配置系统服务，这是 CentOS 7 源码部署 Nginx 的标准流程。
2. **关键注意点**：编译参数按需定制模块，运行用户建议使用非 root 账户（nginx），通过 systemd 管理服务更符合系统规范。
3. **常用命令**：`systemctl start/stop/restart/reload nginx`（启停 / 重启 / 重载配置）、`nginx -t`（验证配置文件语法）。

如果需要自定义 Nginx 配置（如虚拟主机、反向代理），可编辑 `/usr/local/nginx/conf/nginx.conf` 或在 `conf.d` 目录下新增配置文件，修改后执行 `nginx -t` 验证语法，再 `systemctl reload nginx` 重载配置即可。



## 编译参数的疑问？

我有个疑问，编译参数是nginx官方规定的，还是部署其他应用也是这样的？

你这个问题问到了源码编译的核心逻辑，非常有价值！简单来说，`./configure` 这类编译参数**并不是 Nginx 官方独有的**，而是类 Unix 系统下源码编译安装软件的通用机制，只是不同软件的具体参数会根据自身功能定制。

### 一、先理清核心概念

在 CentOS/Ubuntu 等类 Unix 系统中，绝大多数用 C/C++ 编写的开源软件（比如 Nginx、Apache、Redis、PHP 等），都会遵循一套通用的**源码编译三步法**：

```bash
./configure  # 配置（检查环境、定制功能、生成编译规则）
make         # 编译（根据配置规则编译源码）
make install # 安装（将编译好的文件复制到指定目录）
```

其中 `./configure` 是最灵活的一步，也是你疑问的核心。

### 二、为什么会有 `./configure`？

- **通用目的**：`./configure` 本质是一个**配置脚本**（通常由 GNU Autoconf 工具生成），核心作用是：
  1. 检查当前系统环境（比如是否有编译器、依赖库、系统内核版本等）；
  2. 接收用户自定义参数（比如安装路径、启用 / 禁用功能模块）；
  3. 根据检查结果和用户参数，生成适配当前系统的编译规则（比如 Makefile 文件）。
- **Nginx 只是遵循了这个通用标准**，并不是它独创的，不同软件的区别仅在于：**参数名称、支持的功能模块不同**，但核心逻辑完全一致。

### 三、不同软件的 `./configure` 参数对比

用你熟悉的 Nginx 和常见的 Apache、Redis 对比，就能直观看到规律：

| 软件   | 通用核心参数（几乎所有软件都支持）     | 专属功能参数（软件特有）                                     |
| ------ | -------------------------------------- | ------------------------------------------------------------ |
| Nginx  | --prefix=/usr/local/nginx（安装路径）  | --with-http_ssl_module（启用 HTTPS 模块）                    |
| Apache | --prefix=/usr/local/apache（安装路径） | --enable-ssl（启用 SSL）、--enable-rewrite（启用重写）       |
| Redis  | --prefix=/usr/local/redis（安装路径）  | --enable-lua（启用 Lua 脚本）、--disable-protected-mode（关闭保护模式） |

可以看到：

1. **通用参数**：`--prefix`（指定安装路径）是几乎所有开源软件都支持的核心参数，这是行业通用约定；
2. **专属参数**：每个软件会根据自身功能，定义 `--with-xxx`（启用模块）、`--enable-xxx`（启用功能）、`--disable-xxx`（禁用功能）等专属参数，这些是软件开发者自定义的，没有统一标准，但命名逻辑（比如 `--with/--enable` 表启用）是通用的。

### 四、补充：不是所有软件都用 `./configure`

少数软件（比如 Go 语言编写的程序、部分轻量级工具）可能简化了编译流程，比如：

- Go 程序：直接 `go build` 即可，无需 `./configure`；
- 部分简单 C 程序：直接 `gcc 源码文件 -o 可执行文件`，也不需要配置步骤。但绝大多数 C/C++ 编写的主流开源软件（包括 Nginx），都会遵循  `./configure → make → make install`的流程。

### 总结

1. `./configure` 是类 Unix 系统源码编译的**通用机制**，不是 Nginx 官方规定的，而是行业通用标准；
2. 核心通用参数（如 `--prefix`）几乎所有软件都支持，专属功能参数（如 Nginx 的 `--with-http_ssl_module`）由各软件自定义，但命名逻辑（`--with/--enable` 启用、`--without/--disable` 禁用）是通用的；
3. Nginx 的编译参数本质是 “通用机制 + 自身功能定制”，部署其他 C/C++ 开源软件（如 Apache、PHP）时，流程完全一致，仅需替换专属参数即可。

简单记：`./configure` 是 “通用框架”，不同软件往里面填 “专属功能参数”，核心逻辑一通百通。

## 如何在Nginx中配置虚拟主机?

你想要了解在 Nginx 中配置虚拟主机的方法，虚拟主机是 Nginx 最核心的功能之一，它允许你在单台服务器上运行多个网站（域名），这也是生产环境中最常用的配置方式。
### 一、虚拟主机的核心原理

Nginx 通过识别客户端请求的 `Host` 头部信息，将请求转发到对应的配置块（`server` 块），从而实现一台服务器对应多个域名 / 网站。Nginx 支持两种主流的虚拟主机配置方式：

1. **基于域名的虚拟主机**（最常用）：通过不同域名区分不同网站
2. **基于端口的虚拟主机**：通过不同端口区分不同网站

### 二、配置前的准备

1. 确保 Nginx 已安装（可通过 `nginx -v` 验证）
2. 准备好域名（或本地测试用的域名，需修改 `/etc/hosts`）
3. 了解 Nginx 配置文件结构：
   - 主配置文件：`/etc/nginx/nginx.conf`
   - 虚拟主机配置文件推荐放在：`/etc/nginx/conf.d/`（需在 `nginx.conf` 中通过 `include /etc/nginx/conf.d/*.conf;` 引入）

### 三、具体配置步骤

#### 1. 基于域名的虚拟主机（最常用）

**步骤 1：创建虚拟主机配置文件**

```bash
# 新建配置文件（以 example.com 为例）
vim /etc/nginx/conf.d/example.com.conf
```

**步骤 2：写入配置内容**

```nginx
# 第一个虚拟主机：example.com
server {
    # 监听 80 端口（HTTP）
    listen 80;
    # 服务器域名（可写多个，用空格分隔）
    server_name example.com www.example.com;
    
    # 网站根目录（需提前创建，如 /var/www/example.com）
    root /var/www/example.com;
    # 默认首页文件
    index index.html index.htm;

    # 日志配置（便于排查问题）
    access_log /var/log/nginx/example.com_access.log;
    error_log /var/log/nginx/example.com_error.log;

    # 可选：静态文件缓存配置（优化性能）
    location ~* \.(jpg|jpeg|png|css|js)$ {
        expires 7d;  # 缓存7天
    }
}

# 第二个虚拟主机：test.com（同一服务器的另一个域名）
server {
    listen 80;
    server_name test.com www.test.com;
    
    root /var/www/test.com;
    index index.html index.htm;

    access_log /var/log/nginx/test.com_access.log;
    error_log /var/log/nginx/test.com_error.log;
}
```

**步骤 3：创建网站根目录并添加测试文件**

```bash
# 创建 example.com 根目录
mkdir -p /var/www/example.com
echo "Hello from example.com" > /var/www/example.com/index.html

# 创建 test.com 根目录
mkdir -p /var/www/test.com
echo "Hello from test.com" > /var/www/test.com/index.html

# 给 Nginx 赋予目录权限
chown -R nginx:nginx /var/www/
```

**步骤 4：验证配置并重启 Nginx**

```bash
# 检查配置是否有语法错误（关键！）
nginx -t

# 重启 Nginx 使配置生效
systemctl restart nginx
```

#### 2. 基于端口的虚拟主机（备用）

如果需要通过不同端口区分网站（如 8080、8081），配置示例如下：



```nginx
# 端口 8080 的虚拟主机
server {
    listen 8080;
    server_name localhost;  # 无需域名，通过端口访问
    
    root /var/www/port8080;
    index index.html;
}

# 端口 8081 的虚拟主机
server {
    listen 8081;
    server_name localhost;
    
    root /var/www/port8081;
    index index.html;
}
```

### 四、本地测试（无公网域名时）

如果没有真实域名，可修改本地 `/etc/hosts` 文件模拟域名解析：

```bash
# 编辑 hosts 文件
vim /etc/hosts

# 添加以下内容（服务器IP替换为你的服务器地址，本地测试写 127.0.0.1）
127.0.0.1 example.com
127.0.0.1 www.example.com
127.0.0.1 test.com
127.0.0.1 www.test.com
```

保存后，在浏览器访问 `http://example.com` 或 `http://test.com` 即可测试。

### 五、HTTPS 虚拟主机（扩展）

如果需要配置 HTTPS 虚拟主机（主流需求），核心配置如下（需先申请 SSL 证书）：

```nginx
server {
    listen 443 ssl;
    server_name example.com www.example.com;

    # SSL 证书路径
    ssl_certificate /etc/nginx/ssl/example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/example.com.key;

    # SSL 优化配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_session_timeout 1d;

    root /var/www/example.com;
    index index.html;
}

# 强制 HTTP 跳转 HTTPS
server {
    listen 80;
    server_name example.com www.example.com;
    return 301 https://$host$request_uri;
}
```

### 总结

1. **核心配置**：Nginx 虚拟主机的核心是 `server` 块，通过 `listen`（端口）和 `server_name`（域名）区分不同网站。
2. **配置规范**：推荐将不同虚拟主机的配置拆分到 `conf.d/` 目录下的独立 `.conf` 文件，而非直接写在主配置文件，便于维护。
3. **关键步骤**：配置后必须执行 `nginx -t` 验证语法，再重启 Nginx；同时要确保网站根目录权限正确，否则会出现 403 错误。

## 如何在Nginx中启用或禁用功能模块？

你想知道在 Nginx 中如何灵活地启用或禁用功能模块，这是源码编译 Nginx 时的核心操作，也是定制 Nginx 功能的关键。Nginx 模块的启用 / 禁用主要分**编译阶段**（源码编译时）和**运行阶段**（配置文件中）两种场景，其中编译阶段是基础，运行阶段是对已编译模块的开关控制。

### 一、核心场景 1：编译阶段（源码编译时）—— 决定 Nginx 包含哪些模块

这是最根本的方式，因为 Nginx 的模块是**编译进二进制程序**的，只有编译时包含的模块，运行时才能配置使用。

#### 1. 核心语法规则

Nginx 的 `./configure` 配置脚本通过以下固定语法控制模块：

- **启用模块**：`--with-模块名`（大部分功能模块） 或 `--enable-模块名`（少数模块）
- **禁用模块**：`--without-模块名`（禁用默认开启的模块） 或 `--disable-模块名`（少数模块）

#### 2. 实操示例（基于之前的编译命令修改）

```bash
# 进入Nginx源码目录（以1.24.0为例）
cd /usr/local/src/nginx-1.24.0

# 示例1：启用常用模块（HTTPS、HTTP/2、状态监控），禁用默认的邮件模块
./configure \
--prefix=/usr/local/nginx \
--user=nginx \
--group=nginx \
--with-http_ssl_module \          # 启用HTTPS模块（必选，否则无法配置HTTPS）
--with-http_v2_module \           # 启用HTTP/2模块
--with-http_stub_status_module \  # 启用状态监控模块
--without-http_mail_module \      # 禁用默认开启的邮件代理模块（用不到则禁用，减小程序体积）
--without-http_gzip_module \      # 禁用默认开启的gzip压缩模块（示例：不需要则禁用）
--pid-path=/var/run/nginx.pid \
--error-log-path=/var/log/nginx/error.log \
--http-log-path=/var/log/nginx/access.log

# 重新编译安装（修改模块后必须重新编译）
make -j $(grep -c ^processor /proc/cpuinfo)
make install
```

#### 3. 关键操作：查看当前 Nginx 已编译的模块

如果想确认编译后的 Nginx 包含哪些模块，执行以下命令：

```bash
# 查看已编译的所有模块
nginx -V  # 注意是大写V，小写v只显示版本

# 过滤关键模块（比如查看是否启用了SSL模块）
nginx -V 2>&1 | grep -E 'ssl|http2'
```

输出示例（包含 `--with-http_ssl_module` 即表示已启用）：

```plaintext
configure arguments: --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module ...
```

### 二、核心场景 2：运行阶段（配置文件中）—— 开关已编译模块的功能

对于已编译进 Nginx 的模块，你可以在配置文件中通过指令启用 / 禁用其具体功能（无需重新编译）。

#### 1. 常用模块的运行时开关示例

编辑 Nginx 主配置文件 `/usr/local/nginx/conf/nginx.conf`：

```nginx
http {
    # 1. gzip压缩模块（已编译的前提下）
    gzip on;      # 启用gzip压缩（默认off）
    # gzip off;   # 禁用gzip压缩
    
    # 2. HTTPS模块（在server块中配置）
    server {
        listen 443 ssl;  # 启用SSL（HTTPS）
        # listen 443;    # 仅监听443端口，但不启用SSL（无意义，仅示例）
        ssl_certificate /usr/local/nginx/ssl/server.crt;
        ssl_certificate_key /usr/local/nginx/ssl/server.key;
        
        # 3. HTTP/2模块
        listen 443 ssl http2;  # 启用HTTP/2（需先启用SSL）
        # listen 443 ssl;      # 禁用HTTP/2（仅用HTTPS）
    }
    
    # 4. 状态监控模块（启用访问入口）
    server {
        listen 80;
        server_name localhost;
        
        location /nginx_status {
            stub_status on;     # 启用状态监控
            # stub_status off;  # 禁用状态监控
            allow 127.0.0.1;    # 仅允许本地访问
            deny all;
        }
    }
}
```

#### 2. 生效方式

修改配置后，需验证语法并重载配置（无需重启 Nginx）：

```bash
nginx -t  # 验证配置语法（关键！避免配置错误导致Nginx无法启动）
systemctl reload nginx  # 重载配置，使模块开关生效
```

### 三、特殊情况：动态模块（Nginx 1.9.11+ 支持）

传统 Nginx 模块是静态编译的，而 Nginx 1.9.11 及以上版本支持**动态模块**（`.so` 文件），可以在不重新编译主程序的前提下加载 / 卸载模块：

#### 1. 编译动态模块示例

```bash
# 编译时将SSL模块作为动态模块（--with-xxx_module=dynamic）
./configure \
--prefix=/usr/local/nginx \
--with-http_ssl_module=dynamic \  # 编译为动态模块
--modules-path=/usr/local/nginx/modules  # 指定动态模块存放路径

make && make install
```

#### 2. 加载 / 禁用动态模块

在 `nginx.conf` 顶部添加：

```nginx
# 加载动态模块（启用）
load_module /usr/local/nginx/modules/ngx_http_ssl_module.so;

# 禁用动态模块：注释掉上面的load_module指令即可，无需重新编译
# load_module /usr/local/nginx/modules/ngx_http_ssl_module.so;
```

### 总结

1. **编译阶段**：通过 `--with/--enable`（启用）、`--without/--disable`（禁用）控制模块是否被编译进 Nginx，是模块可用的基础，修改后需重新编译安装；
2. **运行阶段**：通过配置文件中的指令（如 `gzip on/off`、`stub_status on/off`）开关已编译模块的功能，修改后仅需重载配置；
3. **动态模块**（Nginx 1.9.11+）：可通过 `load_module` 指令灵活加载 / 禁用模块，无需重新编译主程序，是更灵活的方式。

核心原则：先确保模块在编译阶段被包含，再在运行阶段配置其功能开关；若不需要某个模块，编译时直接禁用可减小 Nginx 程序体积，提升性能。





## 如何在 Nginx 配置文件中使用变量?

你想了解在 Nginx 配置文件中如何使用变量，这是实现灵活配置（比如自定义日志、动态跳转、反向代理）的核心技巧。Nginx 变量分为**内置变量**（系统预定义）和**自定义变量**（用户手动创建）两类，使用方式简单且场景丰富，下面我会从基础用法到实战场景一步步讲解。

### 一、变量的核心基础

#### 1. 变量的基本语法

- Nginx 变量以 `$` 开头，比如 `$remote_addr`、`$request_uri`；
- 变量可在几乎所有指令中使用（如日志格式、location 规则、proxy_pass 等）；
- 变量的值是**请求级别的**：每个 HTTP 请求都会独立计算变量值，互不干扰。

#### 2. 两类核心变量

| 类型       | 说明                    | 示例                                             |
| ---------- | ----------------------- | ------------------------------------------------ |
| 内置变量   | Nginx 预定义，直接使用  | `$remote_addr`（客户端 IP）、`$host`（请求域名） |
| 自定义变量 | 用户通过 `set` 指令创建 | `set $my_var "test";`                            |

### 二、常用内置变量（高频使用）

内置变量是 Nginx 最实用的特性之一，覆盖了请求的所有关键信息，以下是高频使用的内置变量：

| 内置变量           | 含义                                                         |
| ------------------ | ------------------------------------------------------------ |
| `$remote_addr`     | 客户端 IP 地址（如 192.168.1.100）                           |
| `$host`            | 请求的域名（如 [www.example.com](https://www.example.com/)） |
| `$request_uri`     | 完整的请求 URI（含参数，如 /index.html?name=test）           |
| `$uri`             | 去除参数的请求 URI（如 /index.html）                         |
| `$request_method`  | 请求方法（GET/POST/PUT 等）                                  |
| `$status`          | HTTP 响应状态码（如 200/404/500）                            |
| `$http_user_agent` | 客户端浏览器 / 设备信息（User-Agent）                        |
| `$http_referer`    | 来源页面（Referer）                                          |
| `$scheme`          | 请求协议（http/https）                                       |
| `$server_port`     | Nginx 监听的端口（如 80/443）                                |

### 三、自定义变量（set 指令）

通过 `set` 指令可以创建自定义变量，语法：`set $变量名 变量值;`，变量值可以是字符串、内置变量，甚至是变量拼接。

#### 1. 基础用法（定义 + 使用）

nginx











```nginx
http {
    # 在http块定义全局自定义变量（所有server共享）
    set $global_var "global_value";

    server {
        listen 80;
        server_name localhost;

        # 在server块定义局部变量（仅当前server生效）
        set $server_var "server_value";

        location /test {
            # 在location块定义局部变量（仅当前location生效）
            set $local_var "local_value";
            
            # 拼接变量（内置变量 + 自定义变量）
            set $combined_var "$remote_addr - $server_var - $local_var";
            
            # 输出变量值（用于测试，实际场景可用于日志、跳转等）
            return 200 "全局变量：$global_var <br> 局部变量：$combined_var";
        }
    }
}
```

**测试效果**：访问 `http://localhost/test`，会返回：

plaintext











```plaintext
全局变量：global_value 
局部变量：127.0.0.1 - server_value - local_value
```

#### 2. 变量作用域（重要）

- `http` 块定义的变量：所有 `server`/`location` 都能使用；
- `server` 块定义的变量：仅当前 `server` 内的 `location` 能使用；
- `location` 块定义的变量：仅当前 `location` 能使用；
- 子区块的变量会**覆盖**上级同名变量（比如 location 块的 `$var` 会覆盖 server 块的 `$var`）。

### 四、变量的实战场景（核心用法）

变量的价值在于结合业务场景灵活配置，以下是最常用的实战场景：

#### 场景 1：自定义日志格式（最常用）

通过变量定制日志内容，方便后续分析：

nginx











```nginx
http {
    # 自定义日志格式（包含客户端IP、请求方法、URI、状态码、UA）
    log_format custom_log '$remote_addr [$time_local] "$request_method $request_uri" '
                         '$status "$http_user_agent" "$http_referer"';

    # 访问日志使用自定义格式
    access_log /var/log/nginx/custom_access.log custom_log;
}
```

#### 场景 2：动态反向代理（根据 URL 参数 / 域名跳转）

nginx











```nginx
server {
    listen 80;
    server_name example.com;

    location /api {
        # 根据请求URI中的参数动态设置代理地址
        set $backend "127.0.0.1:8080";
        # 如果URI包含 /api/v2，代理到另一个后端
        if ($uri ~* "/api/v2") {
            set $backend "127.0.0.1:8081";
        }
        # 反向代理到动态设置的后端
        proxy_pass http://$backend;
    }
}
```

#### 场景 3：根据客户端 IP 做访问控制

nginx











```nginx
server {
    listen 80;
    server_name localhost;

    location /admin {
        # 定义允许的IP变量
        set $allowed_ips "127.0.0.1 192.168.1.100";
        # 检查客户端IP是否在允许列表中
        if ($allowed_ips !~* $remote_addr) {
            return 403 "Forbidden: Your IP ($remote_addr) is not allowed";
        }
        # 允许访问的逻辑
        root /usr/local/nginx/html/admin;
    }
}
```

#### 场景 4：动态跳转（根据域名 / URI 跳转）

```nginx
server {
    listen 80;
    server_name example.com www.example.com;

    # 非www域名跳转到www
    if ($host != "www.example.com") {
        return 301 $scheme://www.example.com$request_uri;
    }

    # /old路径跳转到/new
    location /old {
        set $new_path "/new";
        return 301 $scheme://$host$new_path$is_args$args;
        # $is_args：如果有参数则为?，无则为空；$args：请求参数
    }
}
```

### 五、使用变量的注意事项

1. **避免无意义的变量拼接**：过多变量拼接会轻微影响 Nginx 性能（可忽略，除非高并发）；

2. **if 指令的坑**：`if` 指令中使用变量时，尽量避免复杂逻辑（Nginx 的 if 不是通用编程语言的 if，部分场景会有意外行为）；

3. **变量值为空的处理**：如果变量值为空，使用时可能导致配置错误（比如 `proxy_pass http://$backend` 中 `$backend` 为空会报错），建议加默认值：

   ```nginx
   set $backend "";
   if ($uri ~ /api) {
       set $backend "127.0.0.1:8080";
   }
   # 加默认值，避免变量为空
   proxy_pass http://${backend:-127.0.0.1:80};
   ```

   

4. **验证变量值**：可通过 `return 200 "$变量名"` 临时输出变量值，排查配置问题。

### 总结

1. Nginx 变量分**内置变量**（直接用，覆盖请求全量信息）和**自定义变量**（通过 `set` 创建），均以 `$` 开头；
2. 变量有**作用域**（http > server > location），子区块变量会覆盖上级同名变量；
3. 核心使用场景：自定义日志、动态反向代理、访问控制、URL 跳转，是灵活配置 Nginx 的核心工具；
4. 关键注意：使用变量时避免为空，`if` 指令中慎用复杂逻辑，修改配置后用 `nginx -t` 验证语法。

掌握变量的用法后，你可以摆脱固定配置的限制，实现更贴合业务需求的 Nginx 配置。



如何在Nginx配置文件中使用自定义变量?→
介绍一些Nginx内置变量的具体使用场景 →
如何在Nginx配置文件中使用变量实现动态跳转?→

如何在 Nginx 中配置虚拟主机?→
如何在 Nginx 中配置 HTTPS? →