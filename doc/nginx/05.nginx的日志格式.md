怎样分析Nginx日志?→

Nginx 日志分为 **访问日志（access.log）** 和 **错误日志（error.log）** 两类，以下是真实场景的日志实例及字段解析。

---

### 一、访问日志（access.log）实例

Nginx 默认使用 **combined** 日志格式，包含请求的核心信息，实例如下：

plaintext

```plaintext
192.168.1.100 - - [10/Oct/2024:14:30:25 +0800] "GET /index.html HTTP/1.1" 200 1234 "https://www.baidu.com/s?wd=nginx" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36" "-"
```

#### 字段解析（按顺序）

|字段|内容|说明|
|---|---|---|
|`192.168.1.100`|客户端 IP|发起请求的客户端地址|
|`-`|远程用户|一般为空（需开启身份验证才会有值）|
|`-`|登录用户|一般为空|
|`[10/Oct/2024:14:30:25 +0800]`|请求时间|格式：`[日/月/年:时:分:秒 时区]`|
|`"GET /index.html HTTP/1.1"`|请求行|包含 **请求方法**、**URI**、**HTTP 协议版本**|
|`200`|状态码|200 = 成功，404 = 资源不存在，500 = 服务器内部错误|
|`1234`|响应字节数|发送给客户端的字节数（不含响应头）|
|`"https://www.baidu.com/..."`|来源 Referer|客户端从哪个页面跳转过来|
|`"Mozilla/5.0 ... Safari/537.36"`|User-Agent|客户端浏览器 / 设备信息|
|`"-"`|额外信息|一般为空，可自定义记录 cookie 等内容|

---

### 二、错误日志（error.log）实例

错误日志记录 Nginx 运行中的异常，包含 **错误级别** 和 **具体原因**，实例如下：

plaintext

```plaintext
2024/10/10 14:35:40 [error] 1234#1234: *567 open() "/usr/share/nginx/html/404.html" failed (2: No such file or directory), client: 192.168.1.100, server: localhost, request: "GET /test HTTP/1.1", host: "192.168.1.200"
```

#### 字段解析

1. `2024/10/10 14:35:40`：错误发生时间
2. `[error]`：错误级别，常见级别从低到高：`debug` > `info` > `notice` > `warn` > `error` > `crit` > `alert` > `emerg`
3. `1234#1234`：Nginx 进程 ID（主进程 #工作进程）
4. `*567`：请求的唯一标识（用于关联访问日志和错误日志）
5. `open() "... failed (2: No such file or directory)`：具体错误信息（找不到 404.html 文件）
6. 后续字段：客户端 IP、服务器名称、请求内容、请求主机

---

### 三、自定义日志格式实例

如果需要记录更多信息（如请求耗时、cookie），可以在 Nginx 配置中自定义格式，示例配置：

nginx

```nginx
http {
    log_format custom '$remote_addr [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" "$request_time" "$http_cookie"';
    
    server {
        access_log /var/log/nginx/custom_access.log custom;
    }
}
```

对应的日志实例（包含请求耗时和 cookie）：

plaintext

```plaintext
192.168.1.100 [10/Oct/2024:15:20:10 +0800] "POST /api/login HTTP/1.1" 200 200 "https://example.com/login" "Chrome/129.0.0.0" "0.05" "token=abc123"
```

---

我可以帮你整理**Nginx 日志分析的常用命令清单**，方便你快速排查访问异常或性能问题，需要吗？

要的

# Nginx 日志分析常用命令清单

以下命令基于 Linux 环境，针对默认 `combined` 格式的 `access.log` 和 `error.log` 设计，可直接用于日志排查、统计和异常定位。

## 一、 访问日志（access.log）分析命令

### 1. 基础统计类

|需求|命令|说明|||||
|---|---|---|---|---|---|---|
|统计总访问量|`wc -l /var/log/nginx/access.log`|直接计算日志行数，对应总请求数|||||
|统计独立 IP 数|`awk '{print $1}' /var/log/nginx/access.log|sort|uniq|wc -l`|提取 IP→去重→计数||
|统计访问量 TOP10 IP|`awk '{print $1}' /var/log/nginx/access.log|sort|uniq -c|sort -nr|head -10`|`-c` 统计次数，`-nr` 按数字降序排序|
|统计 TOP10 访问 URL|`awk '{print $7}' /var/log/nginx/access.log|sort|uniq -c|sort -nr|head -10`|`$7` 对应日志中的请求 URI|
|统计各状态码数量|`awk '{print $9}' /var/log/nginx/access.log|sort|uniq -c|sort -nr`|`$9` 对应 HTTP 状态码（200/404/500 等）||

### 2. 异常排查类

|需求|命令|说明|
|---|---|---|
|筛选 404 请求|`awk '$9 == 404 {print $0}' /var/log/nginx/access.log`|输出所有 404 错误的完整日志|
|筛选 500/502 等服务端错误|`awk '$9 ~ /^5/ {print $0}' /var/log/nginx/access.log`|匹配所有以 5 开头的状态码|
|筛选指定 IP 的所有请求|`grep "192.168.1.100" /var/log/nginx/access.log`|替换为目标 IP 即可|
|筛选指定 URL 的请求|`grep "/api/login" /var/log/nginx/access.log`|替换为目标 URI|
|筛选 POST 请求|`awk '$6 == "\"POST" {print $0}' /var/log/nginx/access.log`|`$6` 对应请求方法（需带引号匹配）|

### 3. 时间范围筛选（按日志时间字段）

bash

运行

```bash
# 筛选 2024-10-10 14:00-15:00 之间的请求（需匹配日志时间格式）
grep "10/Oct/2024:14" /var/log/nginx/access.log
# 筛选某一天的所有请求
grep "10/Oct/2024" /var/log/nginx/access.log
```

## 二、 错误日志（error.log）分析命令

|需求|命令|说明||
|---|---|---|---|
|查看最新错误|`tail -f /var/log/nginx/error.log`|实时跟踪错误日志输出||
|筛选严重错误（error/crit 级别）|`grep -E "error|crit" /var/log/nginx/error.log`|匹配 error 或 crit 级别的日志|
|查找指定客户端的错误|`grep "192.168.1.100" /var/log/nginx/error.log`|定位某 IP 触发的错误||
|查找文件不存在错误|`grep "No such file or directory" /var/log/nginx/error.log`|排查 404 相关的服务端原因||

## 三、 进阶分析命令

### 1. 结合自定义日志（含请求耗时 `$request_time`）

bash

运行

```bash
# 筛选请求耗时超过2秒的请求（自定义日志需包含 $request_time 字段）
awk '$NF > 2 {print $0}' /var/log/nginx/custom_access.log
```

### 2. 日志按时间切割后分析（如 access.log-20241010）

bash

运行

```bash
# 批量统计最近7天的访问量
for log in /var/log/nginx/access.log-202410*; do echo $log; wc -l $log; done
```

## 四、 注意事项

1. 日志路径可能因系统不同而变化（如 CentOS 为 `/var/log/nginx/`，部分自定义安装路径为 `/usr/local/nginx/logs/`）。
2. 若日志已压缩（`.gz` 格式），需先用 `zcat` 解压后再分析，例如：`zcat access.log-20241010.gz | wc -l`。
3. 生产环境建议定期切割日志，避免单个日志文件过大导致分析缓慢。

我可以帮你整理**Nginx 日志切割的配置步骤**，避免日志文件过大影响服务器性能，需要吗？

编辑分享

统计访问量TOP10的访问页面

统计访问量TOP10的访问页面，并按照访问量进行排序

统计访问量TOP10的访问页面，并按照访问量进行排序，只显示前5个页面