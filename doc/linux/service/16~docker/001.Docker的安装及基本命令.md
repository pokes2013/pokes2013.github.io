
## 一、安装环境
CentOS7  root用户
## 二、安装docker

### 1、将yum包更新到最新

```
yum update
```

### 2、安装需要的软件包

yum-utils提供yum-config-manager功能，另外两个devicece mapper是驱动依赖的包

```
yum install -y yum-utils device-mapper-persistent-data lvm2
```

### 3、设置yum源

```
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
```

### 4、安装docker

```
yum install -y docker-ce
```

```
docker -v
Docker version 19.03.6, build 369ce74a3c
```

### 5、配置阿里云加速器

以下获取到的代码就是你的加速代码：

```
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://tue4pc99.mirror.aliyuncs.com"]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
```
## 三、docker服务的管理

```
systemctl start docker      #开启
systemctl stop docker       #停止
systemctl restart docker    #重启
systemctl enable docker     #开机启动
systemctl status docker     #查看状态
```


## 四、镜像的管理命令

### docker search 搜索镜像

搜索远程仓库镜像

NAME（名称）， DESCRIPTION（描述），STARS（点赞数）OFFICIAL（是否官方），AUTOMATED（是否自动流程构建）

```
[root@localhost ~]# docker search mysql
NAME                              DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED
mysql                             MySQL is a widely used, open-source relation…   9152                [OK]                
mariadb                           MariaDB is a community-developed fork of MyS…   3248                [OK]                
mysql/mysql-server                Optimized MySQL Server Docker images. Create…   676                                     [OK]
centos/mysql-57-centos7           MySQL 5.7 SQL database server                   69                                      
mysql/mysql-cluster               Experimental MySQL Cluster Docker images. Cr…   62                                      
centurylink/mysql                 Image containing mysql. Optimized to be link…   61                                      [OK]
deitch/mysql-backup               REPLACED! Please use http://hub.docker.com/r…   41                                      [OK]
bitnami/mysql                     Bitnami MySQL Docker Image                      36                                      [OK]
tutum/mysql                       Base docker image to run a MySQL database se…   34                                      
schickling/mysql-backup-s3        Backup MySQL to S3 (supports periodic backup…   29                                      [OK]
prom/mysqld-exporter                                                              26                                      [OK]
linuxserver/mysql                 A Mysql container, brought to you by LinuxSe…   24                                      
centos/mysql-56-centos7           MySQL 5.6 SQL database server                   19                                      
circleci/mysql                    MySQL is a widely used, open-source relation…   18                                      
mysql/mysql-router                MySQL Router provides transparent routing be…   14                                      
arey/mysql-client                 Run a MySQL client from a docker container      13                                      [OK]
databack/mysql-backup             Back up mysql databases to... anywhere!         10                                      
openshift/mysql-55-centos7        DEPRECATED: A Centos7 based MySQL v5.5 image…   6                                       
fradelg/mysql-cron-backup         MySQL/MariaDB database backup using cron tas…   5                                       [OK]
genschsa/mysql-employees          MySQL Employee Sample Database                  4                                       [OK]
devilbox/mysql                    Retagged MySQL, MariaDB and PerconaDB offici…   2                                       
ansibleplaybookbundle/mysql-apb   An APB which deploys RHSCL MySQL                2                                       [OK]
jelastic/mysql                    An image of the MySQL database server mainta…   1                                       
monasca/mysql-init                A minimal decoupled init container for mysql    0                                       
widdpim/mysql-client              Dockerized MySQL Client (5.7) including Curl…   0                                       [OK]
[root@localhost ~]# 
```
**除了上面的方法搜索镜像之外，你还可以访问官网：hub.docker.com**
### docker pull 下载镜像
以下载MySQL为例。不用加任何版本号，默认就是最新版。最新版latest版本

```
docker pull mysql
```

下载mysql5.5的镜像

```
docker pull mysql:5.5
```

### docker images 查看本地镜像
```
docker images  或者 docker image ls
docker images -q   #查询本地镜像的所有ID号
```
### docker image rm 镜像删除

```
docker image rm mysql:5.5
```

### docker image save 导出镜像

命令格式：

```
docker image save 参数 保存的文件名 镜像名和版本号
```

例如：我们导出MySQL5.5这个镜像到当前目录

```
docker image save -o docker_mysql5.5.tar.gz mysql:5.5
```

### docker image load 导入镜像

例如：从当前目录导入docker_mysql5.5.tar.gz

```
docker image load -i  docker_mysql5.5.tar.gz
```

### docker info  资源查看

守护进程的系统资源设置

```
[root@pokes03 ~]# docker info
Client:
 Debug Mode: false
 
Server:
 Containers: 2    
  Running: 2        #运行的容器数量
  Paused: 0
  Stopped: 0
 Images: 4          #共有几个镜像
 Server Version: 19.03.11    #docker版本
 Storage Driver: overlay2    #存储驱动，如果你的这里是dm说明你的内核版本太低。overlay远比dm强大
  Backing Filesystem: xfs    #文件系统
  Supports d_type: true
  Native Overlay Diff: true
 Logging Driver: json-file
 Cgroup Driver: cgroupfs
 Plugins:
  Volume: local
  Network: bridge host ipvlan macvlan null overlay
  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
 Swarm: inactive
 Runtimes: runc
 Default Runtime: runc
 Init Binary: docker-init
 containerd version: 7ad184331fa3e55e52b890ea95e65ba581ae3429
 runc version: dc9208a3303feef5b3839f4323d9beb36df0a9dd
 init version: fec3683
 Security Options:
  seccomp
   Profile: default
 Kernel Version: 3.10.0-1127.8.2.el7.x86_64    #内核版本
 Operating System: CentOS Linux 7 (Core)
 OSType: linux
 Architecture: x86_64
 CPUs: 1
 Total Memory: 468.4MiB    #资源数
 Name: pokes03
 ID: J2RQ:MO7G:TEZO:UIRQ:NJDJ:XCSH:X7MN:KYJE:BBOE:GP5F:WT4S:HVOE
 Docker Root Dir: /var/lib/docker
 Debug Mode: false
 Registry: https://index.docker.io/v1/
 Labels:
 Experimental: false
 Insecure Registries:
  127.0.0.0/8
 Registry Mirrors:
  https://tue4pc99.mirror.aliyuncs.com/    #加速的镜像站点
 Live Restore Enabled: false
 
WARNING: bridge-nf-call-iptables is disabled
WARNING: bridge-nf-call-ip6tables is disabled
```



## 五、容器管理命令

### docker ps 查看容器的进程

```
docker ps   查看运行的容器
docker container ls  查看运行的容器
```
```
[root@linuxftp243 ~]# docker container ls -a
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                    NAMES
44d883dcdb5e        kylemanna/openvpn   "ovpn_run"          10 hours ago        Up 10 hours         0.0.0.0:1194->1194/udp   openvpn-server
[root@linuxftp243 ~]# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                    NAMES
44d883dcdb5e        kylemanna/openvpn   "ovpn_run"          10 hours ago        Up 10 hours         0.0.0.0:1194->1194/udp   openvpn-server

```

有些容器会死掉，我们也想查看，就需要

```
docker container ls -a
docker ps -a
```

这样就列出了所有的容器，我们可以根据STATUS容器的状态，来判断哪些容器死掉，哪些还在运行。

STATUS容器的状态

- Created 已创建

- exited  退出
- Up 10 hours 类似这种都是运行中的

我们还可以使用

```
docker container start openvpn-server   #把死掉或者出于退出状态的容器运行起来，后面跟容器名字
```



### docker run 运行镜像生成容器

```
docker run -d -p 80:80 nginx
```

- run 创建并运行一个容器
- -d 放在后台运行，不加会扛住
- -p 端口映射
- nginx 镜像的名字

重启docker服务后，所有的容器都会退出。再次执行是不会有冲突的。

### docker exec  进入到容器里面

方法1：

```
docker run -it --name centos6 centos:6.9 /bin/bash
```

- -it 分配交互式终端
- --name 指定容器的名字
- /bin/bash  覆盖容器的初始命令

方法2：

```
docker exec -it 7752222e1e1 /bin/bash
```

-it 是重新分配一个终端

### docker stop 停止容器

```
docker stop 容器ID号
```
最好是使用ID，如果使用名称则还需要加上版本号

**停止所有运行的容器**

```bash
docker stop $(docker ps -aq)       #停止所有运行的容器
等价于
docker stop `docker ps -aq`        #停止所有运行的容器
```
以上两个命令是等价的。

### docker kill 杀死容器

```
docker kill 容器名
```

### docker rm  删除容器
```
docker+rm+镜像ID或者名称和版本号
```
==删除容器之前，必须先停止容器，否则无法删除。==

### 批量删除容器的方法

```dockerfile
docker ps -aq  列出所有容器的ID
docker container rm `docker ps -aq`   删除所有停止的容器，运行的不删
docker container rm -f `docker ps -aq`  强制删除所有容器，包含运行的
```
### docker inspect 查看容器所有基本信息

```
[root@pokes03 ~]# docker inspect wordpress:latest
```
### docker logs 查看容器日志

```bash
docker logs 容器ID
```
### docker commit 制作镜像

```
docker commit -a="lonely" -m="test commit" 原容器id  lonely/mytomcat:1.0
```
- commit：提交镜像，将容器id对应的镜像修改后，使用commit生产 自定义镜像
- lonely/mytomcat 表示镜像名
- 1.0 : 表示镜像版本
- -a= : 表明作者
- -m=：新镜像的描述信息

## 六、docker网络

### 端口映射

#### 端口映射的原理

![在这里插入图片描述](../../../typora-tu/001.Docker的安装及基本命令/20200926174534725.png)

docker容器的IP信息
下面面这一段这就是docker 的网络，我们可以看到它的网段是172.17.0.0段的。

```
3: docker0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:b6:4b:f0:16 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:b6ff:fe4b:f016/64 scope link 
       valid_lft forever preferred_lft forever
```

我们进入到此容器中看一下IP地址

```
[root@linuxftp243 ~]# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                    NAMES
44d883dcdb5e        kylemanna/openvpn   "ovpn_run"          13 hours ago        Up 13 hours         0.0.0.0:1194->1194/udp   openvpn-server

[root@linuxftp243 ~]# docker exec -it 44d883dcdb5e /bin/bash
bash-5.0# 
bash-5.0# 
bash-5.0# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 100
    link/none 
    inet 192.168.255.1 peer 192.168.255.2/32 scope global tun0
       valid_lft forever preferred_lft forever
16: eth0@if17: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
bash-5.0# 
```

==其他机器无法ping通，只有宿主机能ping通。==

#### 端口映射查看

```
netstat -lntup
```

指定端口映射 docker 会自动增加一条iptables规则来实现端口映射。

![在这里插入图片描述](../../../typora-tu/001.Docker的安装及基本命令/20200919140045321.png)

#### 端口映射的语法

```
-p 80：80 
-p 192.168.0.243:80:80
-p 192.168.0.243::80   宿主机是随机端口映射容器80端口，两个冒号。随机成啥端口可以通过docker ps查看
以上未指定协议，默认都是TCP，如果是UDP就必须指定
-p 192.168.0.243::1194/udp    宿主机是随机端口，容器是1194，协议是udp
-p 81:80 -p
```

如果有多个容器都要使用同一个端口例如80端口，我们就可以利用一个网卡支持多个IP的方法实现.

作法可以参考这里：https://blog.csdn.net/libaineu2004/article/details/79214910

### Docker的网络模式

参考这里：https://blog.csdn.net/smooth00/article/details/82842234

Docker有四种网络模式：Bridge、Host、Container、None，一般常用的是前面两种，默认的是第一种，不安全的是第二种，以下介绍一下四种网络模式，并重点介绍一下如何配置自己的跨主机通信网络。

### Docker容器之间跨主机通信

## 七、docker容器的数据持久化

## 八、dockerfile文件详解

## 九、搭建私有镜像仓库

### 私有仓库的上传与下载

## 十、docker-compose

### docker-compose安装

### docker-compose详解

### 编写docker-compose.yml

### 项目部署实战练习

#### docker部署wordpress

```
version: '2'

services:
   db:
     image: mysql:5.7
     restart: always
     environment:
       MYSQL_ROOT_PASSWORD: wordpress
       MYSQL_DATABASE: wordpress
       MYSQL_USER: wordpress
       MYSQL_PASSWORD: wordpress

   wordpress:
      depends_on:
        - db
      image: wordpress:latest
      restart: always
      ports:
        - "8000:80"
      environment:
        WORDPRESS_DB_HOST: db:3306
        WORDPRESS_DB_USER: wordpress
        WORDPRESS_DB_PAASWORD: wordpress
```



#### 批量部署tomcat容器、MySQL容器部署

```
version: '3.1'
services:
  mysql:
    restart: always   #代表只要docker启动，那么这个容器就跟着启动
    image: daocloud.io/library/mysql:5.7.4   #指定镜像的下载地址
    container_name: mysql   #指定容器的名称
    ports:
      - 3306:3306   #端口号的映射
    envirronment:       #环境
      MYSQL_ROOT_PAASWORD: root   #指定mysql的root用户登录密码
      TZ: Asia/Shanghai   #指定时区
    volumes:
      - /opt/docker_mysql/data:/varlib/mysql   #映射数据卷
  tomcat:
    restart: always
    image: daocloud.io/library/tomcat:8.5.15-jre8
    container_name: tomcat
    ports:
      - 8080:8080
    envirronment:
      TZ: Asia/Shanghai
    volumes:
      - /opt/docker_mysql_tomcat/tomcat_webapps:/usr/local/tomcat/webapps
      - /opt/docker_mysql_tomcat/tomcat_logs：/usr/local/tomcat/logs
```

十一、docker跨主机