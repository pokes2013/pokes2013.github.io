# Linux 下 MySQL/MariaDB 完整教程（安装+配置+权限+备份恢复+主从复制）
> ✅ 适配：CentOS 7/8/9 / RockyLinux / AlmaLinux（主流RHEL系），MySQL 8.0 / MariaDB 10.5+，**MySQL和MariaDB操作几乎完全通用**，本文指令两者均可直接使用
> ✅ 包含：完整安装配置、用户权限精细化管理、两种主流备份恢复（mysqldump逻辑备份+xtrabackup物理备份）、主从复制（一主一从）完整搭建+故障排查

---

## 一、基础环境准备（必做）

必做，防止安装失败

### 1. 关闭防火墙（生产/测试通用，放行MySQL端口）
```bash
# CentOS7+/RHEL7+ 防火墙放行3306端口（永久生效）
firewall-cmd --add-port=3306/tcp --permanent
firewall-cmd --reload
# 临时关闭防火墙（测试环境快捷方式）
systemctl stop firewalld && systemctl disable firewalld
```

### 2. 关闭SELINUX（必做，否则权限/端口/备份均会异常）
```bash
# 临时关闭（立即生效，重启失效）
setenforce 0
# 永久关闭（核心，重启生效）
sed -i 's/^SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
```

### 3. 安装依赖+清理冲突组件
```bash
yum install -y wget vim net-tools lrzsz gcc gcc-c++
# 卸载系统自带的 mariadb-libs 冲突包（否则安装失败）
yum remove -y mariadb-libs
```

---

## 二、MySQL / MariaDB 安装

（两种方案，任选其一）

### ✅ 方案1：安装 MySQL 8.0（企业主流，推荐生产）
#### 1. 配置MySQL官方yum源
```bash
wget https://repo.mysql.com//mysql80-community-release-el8-3.noarch.rpm
rpm -ivh mysql80-community-release-el8-3.noarch.rpm
```
#### 2. 安装MySQL服务端+客户端
```bash
yum install -y mysql-community-server
```
#### 3. 启动并开机自启
```bash
systemctl start mysqld && systemctl enable mysqld
# 检查运行状态
systemctl status mysqld
```

### ✅ 方案2：安装 MariaDB 10.5（开源免费，完全兼容MySQL，推荐测试/中小企业）
#### 1. 配置MariaDB官方yum源
```bash
curl -LsS -O https://downloads.mariadb.com/MariaDB/mariadb_repo_setup
bash mariadb_repo_setup --mariadb-server-version=10.5
```
#### 2. 安装MariaDB服务端+客户端
```bash
yum install -y mariadb-server mariadb
```
#### 3. 启动并开机自启
```bash
systemctl start mariadb && systemctl enable mariadb
# 检查运行状态
systemctl status mariadb
```

---

## 三、初始化配置 & 基础优化（重中之重，必做）
### 1. 初始化密码（核心，MySQL和MariaDB区分操作）
#### ✔️ MySQL 8.0 初始化密码
MySQL8安装后会自动生成**临时密码**在日志文件中，必须先获取临时密码，再修改为自定义密码：
```bash
# 1. 获取临时密码（复制输出的字符串即可，不含空格）
grep 'temporary password' /var/log/mysqld.log
# 2. 登录MySQL（粘贴上述临时密码）
mysql -uroot -p
# 3. 修改自定义密码（要求：大小写+数字+特殊符号，复杂度符合要求）
ALTER USER 'root'@'localhost' IDENTIFIED BY 'MySql@2026!';
# 4. 刷新权限，生效配置
FLUSH PRIVILEGES;
```

#### ✔️ MariaDB 初始化密码
MariaDB默认无密码，执行初始化脚本配置密码+安全策略：
```bash
# 执行安全初始化脚本，按提示操作
mysql_secure_installation
```
执行后交互步骤：
1. Enter current password for root：直接回车（无初始密码）
2. Set root password? [Y/n]：输入 `Y` → 输入自定义密码 → 确认密码
3. Remove anonymous users? [Y/n]：输入 `Y`（删除匿名用户，必做）
4. Disallow root login remotely? [Y/n]：输入 `Y`（禁止root远程登录，安全）
5. Remove test database and access to it? [Y/n]：输入 `Y`（删除测试库）
6. Reload privilege tables now? [Y/n]：输入 `Y`（刷新权限）

### 2. 核心配置优化（my.cnf）
MySQL/MariaDB 核心配置文件都是 `/etc/my.cnf`，修改后**必须重启服务生效**，以下是生产级优化配置，直接覆盖即可：
```bash
# 备份原配置文件
cp /etc/my.cnf /etc/my.cnf.bak
# 写入优化配置
cat > /etc/my.cnf << EOF
[mysqld]
datadir=/var/lib/mysql
socket=/var/lib/mysql/mysql.sock
symbolic-links=0
log-error=/var/log/mysqld.log
pid-file=/var/run/mysqld/mysqld.pid
# 基础配置
user=mysql
port=3306
bind-address=0.0.0.0  # 允许所有IP连接，生产可改为指定IP
character-set-server=utf8mb4
collation-server=utf8mb4_general_ci
default-storage-engine=InnoDB
# 性能优化
innodb_buffer_pool_size=512M  # 内存的50%-70%，根据服务器调整
max_connections=1024
wait_timeout=600
interactive_timeout=600
# 主从复制必备配置（开启二进制日志）
server-id=1  # 主库必须=1，从库必须≠1，且唯一
log_bin=mysql-bin  # 开启binlog日志，文件前缀名
binlog_format=ROW  # 推荐ROW格式，数据一致性最高
expire_logs_days=7  # binlog日志保留7天，自动清理
EOF
```
重启服务生效配置：
```bash
# MySQL
systemctl restart mysqld
# MariaDB
systemctl restart mariadb
```

---

## 四、MySQL/MariaDB 用户创建 & 精细化权限管理（生产核心）
> ⚠️ 核心原则：**严禁使用root账号进行业务操作**，生产必须创建「业务专属用户」，并遵循「最小权限原则」授权，禁止赋权`ALL PRIVILEGES *.*`
> ✅ 所有权限操作，最后**必须执行 `FLUSH PRIVILEGES;` 刷新权限生效**

### 1. 权限相关核心概念
- `localhost`：仅允许本机登录，安全级别最高（推荐管理员使用）
- `%`：允许任意远程IP登录（推荐业务用户使用）
- 权限粒度：`库.表`，如 `testdb.*` 代表testdb库下所有表，`*.*` 代表所有库所有表
- 常用权限：`select,insert,update,delete`（业务只读/读写）、`create,drop`（建库建表）、`grant option`（赋权权限，谨慎授予）

### 2. 常用权限操作命令（登录MySQL后执行，通用）
#### ✔️ 创建用户（指定登录IP+密码）
```sql
-- 创建 本机登录 的用户：user1，密码 User1@2026!
CREATE USER 'user1'@'localhost' IDENTIFIED BY 'User1@2026!';

-- 创建 远程登录 的用户：user2，允许任意IP连接，密码 User2@2026!
CREATE USER 'user2'@'%' IDENTIFIED BY 'User2@2026!';

-- 创建 仅指定IP登录 的用户：user3，仅允许192.168.1.100连接
CREATE USER 'user3'@'192.168.1.100' IDENTIFIED BY 'User3@2026!';
```

#### ✔️ 授权用户（最小权限原则，核心）
```sql
-- 授权：user2 拥有 testdb 库下所有表的 增删改查 权限（远程业务常用）
GRANT select,insert,update,delete ON testdb.* TO 'user2'@'%';

-- 授权：user1 拥有所有库的所有权限（本机管理员，谨慎）
GRANT ALL PRIVILEGES ON *.* TO 'user1'@'localhost';

-- 授权：带赋权权限（可以给其他用户授权，慎用）
GRANT select ON testdb.* TO 'user2'@'%' WITH GRANT OPTION;
```

#### ✔️ 刷新权限（所有权限操作后必执行）
```sql
FLUSH PRIVILEGES;
```

#### ✔️ 查询用户/权限（审计必备）
```sql
-- 查询所有用户及登录IP
SELECT user,host FROM mysql.user;

-- 查询指定用户的权限
SHOW GRANTS FOR 'user2'@'%';
```

#### ✔️ 修改用户密码/删除用户
```sql
-- 修改user2的密码
ALTER USER 'user2'@'%' IDENTIFIED BY 'NewPass@2026!';

-- 删除无用用户
DROP USER 'user3'@'192.168.1.100';
```

#### ✔️ 收回用户权限
```sql
-- 收回user2的删除权限
REVOKE delete ON testdb.* FROM 'user2'@'%';
```

---

## 五、MySQL 备份与恢复（两种主流方案，全覆盖生产场景）
生产环境备份是**重中之重**，两种方案互补，没有最好只有最合适：
- **mysqldump**：逻辑备份，轻量、简单、跨版本兼容，适合**小数据量（<50G）、全量备份+简单增量**
- **xtrabackup**：物理备份，专业、高效、支持**热备份、增量备份、大数据库（>50G）**，生产首选，必学！

### ✅ 方案一：mysqldump 备份与恢复（逻辑备份，内置工具，无需额外安装）
> mysqldump 是MySQL/MariaDB**自带工具**，无需安装，直接使用，核心优势：简单、灵活、备份文件为SQL文本，可编辑、可跨版本恢复

#### 1. 核心备份命令（常用场景全覆盖）
```bash
# 场景1：备份 单个数据库（生产最常用）
mysqldump -uroot -p'你的密码' -B testdb > /data/backup/testdb_$(date +%F).sql

# 场景2：备份 多个数据库
mysqldump -uroot -p'你的密码' -B testdb db2 db3 > /data/backup/multi_db_$(date +%F).sql

# 场景3：备份 所有数据库（完整备份）
mysqldump -uroot -p'你的密码' -A > /data/backup/all_db_$(date +%F).sql

# 场景4：备份指定库+压缩（节省磁盘空间，推荐）
mysqldump -uroot -p'你的密码' -B testdb | gzip > /data/backup/testdb_$(date +%F).sql.gz
```
> 参数说明：`-B` 保留库创建语句，恢复时无需手动建库；`-A` 备份所有库；`--single-transaction` 针对InnoDB，热备份不锁表

#### 2. mysqldump 恢复命令
```bash
# 恢复 单个数据库（前提：备份文件带-B参数）
mysql -uroot -p'你的密码' < /data/backup/testdb_2026-01-11.sql

# 恢复 压缩的备份文件
gzip -d < /data/backup/testdb_2026-01-11.sql.gz | mysql -uroot -p'你的密码'

# 恢复到 指定数据库（备份文件无-B参数时）
mysql -uroot -p'你的密码' testdb < /data/backup/testdb_2026-01-11.sql
```

### ✅ 方案二：xtrabackup 备份与恢复（物理备份，生产首选，必学）
> ✅ 工具介绍：`xtrabackup` 是Percona公司开源的免费物理备份工具，支持 **MySQL/MariaDB/Percona Server**
> ✅ 核心优势：**热备份（不锁表）、速度快、支持全量/增量备份、恢复效率高**，适合生产环境大数据库
> ✅ 安装的是 `percona-xtrabackup-80`，兼容MySQL8.0/MariaDB10.5+

#### 1. 安装 xtrabackup
```bash
# 安装yum源
yum install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm
# 安装xtrabackup 8.0
yum install -y percona-xtrabackup-80
# 验证安装成功
xtrabackup --version
```

#### 2. xtrabackup 核心备份命令（全量备份+增量备份）
##### ✔️ ① 全量备份（基础，所有增量备份都基于全量）
```bash
# 创建备份目录
mkdir -p /data/backup/xtrabackup_full /data/backup/xtrabackup_inc
# 执行全量备份（无需停库，不锁表，生产随时执行）
xtrabackup --user=root --password='你的密码' --backup --target-dir=/data/backup/xtrabackup_full/$(date +%F)
```

##### ✔️ ② 增量备份（基于最近一次全量备份，仅备份变化的数据，节省空间和时间）
```bash
# 第一次增量备份（基于全量）
xtrabackup --user=root --password='你的密码' --backup --target-dir=/data/backup/xtrabackup_inc/$(date +%F)_inc1 --incremental-basedir=/data/backup/xtrabackup_full/2026-01-11

# 第二次增量备份（基于上一次增量）
xtrabackup --user=root --password='你的密码' --backup --target-dir=/data/backup/xtrabackup_inc/$(date +%F)_inc2 --incremental-basedir=/data/backup/xtrabackup_inc/2026-01-11_inc1
```

#### 3. xtrabackup 恢复命令（核心，分步骤执行，必须严格按顺序）
> 恢复前提：停止数据库服务 → 清空数据目录 → 准备备份文件 → 恢复数据 → 启动服务
```bash
# 步骤1：停止MySQL/MariaDB服务
systemctl stop mysqld  # MySQL
# systemctl stop mariadb  # MariaDB

# 步骤2：清空数据目录（备份重要数据，谨慎操作）
mv /var/lib/mysql /var/lib/mysql.bak
mkdir -p /var/lib/mysql

# 步骤3：准备全量备份文件（--prepare 是核心，--apply-log-only 只准备不回滚）
xtrabackup --prepare --apply-log-only --target-dir=/data/backup/xtrabackup_full/2026-01-11

# 步骤4：合并增量备份到全量（按增量顺序执行，最后一次增量不加 --apply-log-only）
xtrabackup --prepare --apply-log-only --target-dir=/data/backup/xtrabackup_full/2026-01-11 --incremental-dir=/data/backup/xtrabackup_inc/2026-01-11_inc1
xtrabackup --prepare --target-dir=/data/backup/xtrabackup_full/2026-01-11 --incremental-dir=/data/backup/xtrabackup_inc/2026-01-11_inc2

# 步骤5：执行恢复（核心命令，将备份文件恢复到数据目录）
xtrabackup --copy-back --target-dir=/data/backup/xtrabackup_full/2026-01-11

# 步骤6：修改数据目录权限（必须，否则启动失败）
chown -R mysql:mysql /var/lib/mysql

# 步骤7：启动服务并验证
systemctl start mysqld
mysql -uroot -p -e "show databases;"
```

---

## 六、MySQL/MariaDB 主从复制搭建（一主一从，生产标配，完整无坑）
### ✅ 主从复制核心原理
1. 主库（Master）开启 **binlog二进制日志**，记录所有数据库的增删改操作；
2. 从库（Slave）启动两个线程：`IO线程` + `SQL线程`；
3. IO线程：连接主库，读取主库的binlog日志，写入从库的 `中继日志(relay log)`；
4. SQL线程：读取中继日志，执行日志中的SQL语句，实现**数据同步**；
5. 核心保证：**主库写，从库读**，实现读写分离，分担主库压力，同时实现数据容灾。

### ✅ 环境准备（两台服务器，核心要求）
- 主库（Master）：192.168.1.10 ，`server-id=1`（必须唯一，建议用IP最后一段）
- 从库（Slave）：192.168.1.11 ，`server-id=2`（必须≠主库，唯一即可）
- 两台服务器均已安装并配置好MySQL/MariaDB，且版本一致
- 两台服务器互通（ping通，3306端口放行）
- 主库已开启binlog日志（前文my.cnf已配置，必开！）

### ✅ 步骤1：主库（Master）配置（核心，3步完成）
#### 1. 修改主库 my.cnf 配置（已配置可跳过，确认即可）
```ini
[mysqld]
server-id=1          # 唯一，必须=1
log_bin=mysql-bin    # 开启binlog，必开
binlog_format=ROW    # 同步格式，推荐ROW
expire_logs_days=7   # binlog日志保留7天
```
重启主库生效：`systemctl restart mysqld`

#### 2. 登录主库，创建「主从复制专属用户」（仅授予复制权限，最小权限）
```sql
# 登录主库mysql
mysql -uroot -p'你的密码'
# 创建复制用户 repl，允许从库IP登录，密码 Repl@2026!
CREATE USER 'repl'@'192.168.1.11' IDENTIFIED BY 'Repl@2026!';
# 授予复制权限（仅同步需要，无其他权限，安全）
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'192.168.1.11';
# 刷新权限
FLUSH PRIVILEGES;
```

#### 3. 主库锁定表，查看binlog状态（核心，记录两个值！）
```sql
# 锁定所有表，禁止写入，保证备份数据一致性（只读不写）
FLUSH TABLES WITH READ LOCK;
# 查看binlog状态，记录以下两个值，后续从库配置必须用！
SHOW MASTER STATUS;
```
执行结果如下，记录：
- **File**: mysql-bin.000001 （binlog日志文件名）
- **Position**: 156 （日志偏移量，同步起始位置）
> ⚠️ 重要：此窗口**不要关闭**，关闭则锁表失效！备份完成后再解锁！

#### 4. 主库全量备份，解锁表
```bash
# 新开一个终端，登录主库，执行全量备份（xtrabackup/mysqldump均可）
mysqldump -uroot -p'你的密码' -A -B --master-data=2 > /data/backup/master_full.sql
# 备份完成后，回到mysql窗口，解锁表，允许写入
UNLOCK TABLES;
```
将备份文件传输到从库：`scp /data/backup/master_full.sql root@192.168.1.11:/data/backup/`

### ✅ 步骤2：从库（Slave）配置（核心，4步完成）
#### 1. 修改从库 my.cnf 配置
```ini
[mysqld]
server-id=2          # 唯一，必须≠主库，建议=2
relay_log=relay-bin  # 开启中继日志，必开（从库核心）
log_slave_updates=1  # 从库执行的同步操作，也记录到自己的binlog（可选，级联复制需要）
read_only=1          # 从库只读，禁止手动写入（生产必开，仅root可写）
```
重启从库生效：`systemctl restart mysqld`

#### 2. 从库恢复主库的全量备份（实现数据初始化一致）
```bash
mysql -uroot -p'你的密码' < /data/backup/master_full.sql
```

#### 3. 登录从库，配置主从同步参数（核心，填入主库信息+记录的binlog值）
```sql
# 登录从库mysql
mysql -uroot -p'你的密码'
# 停止从库同步服务（默认未启动）
STOP SLAVE;
# 配置主库信息，严格填入以下参数
CHANGE MASTER TO
MASTER_HOST='192.168.1.10',        # 主库IP
MASTER_USER='repl',                # 主库创建的复制用户
MASTER_PASSWORD='Repl@2026!',      # 复制用户密码
MASTER_LOG_FILE='mysql-bin.000001',# 主库SHOW MASTER STATUS的File值
MASTER_LOG_POS=156;                # 主库SHOW MASTER STATUS的Position值
```

#### 4. 启动从库同步服务，查看同步状态
```sql
# 启动从库同步
START SLAVE;
# 查看主从同步状态（核心命令，必看！）
SHOW SLAVE STATUS\G;
```

### ✅ 主从同步成功的核心判定（重中之重，必须满足）
执行 `SHOW SLAVE STATUS\G;` 后，以下两个参数必须为 `Yes`，否则同步失败：
```
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
```
> ✅ 其他关键参数：`Seconds_Behind_Master: 0` → 延迟0秒，数据实时同步

### ✅ 主从复制测试
1. 在主库创建一个数据库：`CREATE DATABASE test_repl;`
2. 在主库创建一张表并插入数据：`CREATE TABLE test_repl.t1(id int); INSERT INTO test_repl.t1 VALUES(1);`
3. 在从库执行：`SHOW DATABASES;` → 能看到test_repl库
4. 在从库执行：`SELECT * FROM test_repl.t1;` → 能查到数据，同步成功！

### ✅ 常见同步失败排查
1. Slave_IO_Running: No → 网络不通/主库账号密码错误/主库3306端口未放行
2. Slave_SQL_Running: No → 主从数据不一致/从库手动写入数据/主库执行了从库不支持的SQL
3. 解决方案：重新全量备份主库，恢复到从库，重新配置同步参数即可。

---

## 七、所有核心命令总结（速查手册，收藏备用）
### 1. 服务启停
```bash
# MySQL
systemctl start/stop/restart/status/enable mysqld
# MariaDB
systemctl start/stop/restart/status/enable mariadb
```

### 2. 备份恢复
```bash
# mysqldump全量备份
mysqldump -uroot -p密码 -B 库名 > 备份文件.sql
# xtrabackup全量备份
xtrabackup --user=root --password=密码 --backup --target-dir=备份目录
# xtrabackup恢复
xtrabackup --copy-back --target-dir=备份目录
```

### 3. 主从核心命令
```sql
# 主库
SHOW MASTER STATUS;
FLUSH TABLES WITH READ LOCK;
UNLOCK TABLES;

# 从库
STOP SLAVE;
START SLAVE;
CHANGE MASTER TO ...;
SHOW SLAVE STATUS\G;
```

---

## 总结
本文覆盖了Linux下MySQL/MariaDB从**安装到生产运维**的全流程核心内容，重点总结：
1. 安装：MySQL8.0和MariaDB任选，配置my.cnf是基础，必须开启binlog；
2. 权限：最小权限原则，禁止root远程登录，业务用户仅授予必要权限；
3. 备份：mysqldump适合小数据量，xtrabackup适合生产大数据库，增量备份必学；
4. 主从：核心是binlog+中继日志，主库写从库读，实现读写分离和容灾，同步成功的核心是两个`Yes`。

所有命令均经过实测，无坑可直接执行，建议收藏备用！