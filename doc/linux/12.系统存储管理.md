



# Linux 磁盘管理全流程：分区、LVM、RAID、NFS
本文将从**磁盘分区（fdisk/gdisk）**、**LVM逻辑卷管理**、**RAID阵列配置**、**NFS共享存储**四个核心模块，为你提供详细的操作步骤和原理说明，适合初学者理解和实践。

> 包含知识点：磁盘分区（fdisk/gdisk）、LVM 逻辑卷管理（创建 / 扩展 / 缩减）、RAID 阵列配置、NFS 共享存储

## 一、 磁盘分区（fdisk/gdisk）
磁盘分区是对物理磁盘的划分，`fdisk` 用于 **MBR分区表**（支持最大2TB磁盘、最多4个主分区），`gdisk` 用于 **GPT分区表**（支持大于2TB磁盘、无分区数量限制）。

### 1. 查看磁盘信息
首先确认待分区的磁盘设备名（如 `/dev/sdb`）：
```bash
lsblk  # 列出所有块设备及分区
fdisk -l /dev/sdb  # 查看指定磁盘的分区表信息
```

### 2. fdisk 分区（MBR）
以 `/dev/sdb` 为例，创建一个主分区：
```bash
fdisk /dev/sdb  # 进入fdisk交互模式
```
交互命令说明：
| 命令 | 作用 |
|------|------|
| `n` | 创建新分区 |
| `p` | 选择主分区（最多4个） |
| `e` | 选择扩展分区 |
| `d` | 删除分区 |
| `w` | 保存分区表并退出 |
| `q` | 不保存退出 |

操作步骤：
1. 输入 `n` → `p` → 分区号（默认1）→ 起始扇区（默认）→ 结束扇区（如 `+10G` 表示10GB大小）
2. 输入 `w` 保存，系统会提示同步分区表
3. 刷新分区表（无需重启）：
   ```bash
   partprobe /dev/sdb
   ```

### 3. gdisk 分区（GPT）
适用于大容量磁盘，操作与 `fdisk` 类似：
```bash
gdisk /dev/sdb  # 进入gdisk交互模式
```
核心命令：`n`（新建分区）、`d`（删除）、`w`（保存）、`q`（退出）。
GPT分区无需区分主分区/扩展分区，直接创建即可。

## 二、 LVM 逻辑卷管理
LVM（Logical Volume Manager）的核心优势是**动态调整磁盘容量**，无需停机，由 **物理卷(PV)、卷组(VG)、逻辑卷(LV)** 三层结构组成。
- **物理卷(PV)**：由分区或整块磁盘创建，是LVM的底层存储单元。
- **卷组(VG)**：将多个PV合并成一个存储池，统一管理容量。
- **逻辑卷(LV)**：从VG中划分的逻辑分区，可格式化后挂载使用。

### 1. LVM 创建流程
#### 步骤1：创建物理卷（PV）
先对分区（如 `/dev/sdb1`）设置LVM类型（fdisk中设为 `8e`，gdisk中设为 `8e00`），再创建PV：
```bash
# 方法1：分区创建PV
pvcreate /dev/sdb1  

# 方法2：整块磁盘创建PV（跳过分区步骤）
pvcreate /dev/sdc
```
查看PV信息：
```bash
pvdisplay  # 详细信息
pvs  # 简洁信息
```

#### 步骤2：创建卷组（VG）
将1个或多个PV加入VG，命名为 `vg_data`：
```bash
vgcreate vg_data /dev/sdb1 /dev/sdc  # 把sdb1和sdc加入vg_data
```
查看VG信息：
```bash
vgdisplay  # 详细信息
vgs  # 简洁信息
```

#### 步骤3：创建逻辑卷（LV）
从VG中划分容量创建LV，命名为 `lv_data`，大小10GB：
```bash
lvcreate -L 10G -n lv_data vg_data
# -L 指定大小；-n 指定LV名称；vg_data 是所属VG
```
查看LV信息：
```bash
lvdisplay  # 详细信息
lvs  # 简洁信息
# LV的设备路径：/dev/vg_data/lv_data 或 /dev/mapper/vg_data-lv_data
```

#### 步骤4：格式化与挂载
LV创建后需格式化文件系统（如ext4）并挂载：
```bash
# 格式化
mkfs.ext4 /dev/vg_data/lv_data

# 临时挂载
mkdir /mnt/data
mount /dev/vg_data/lv_data /mnt/data

# 永久挂载（写入/etc/fstab）
echo "/dev/vg_data/lv_data /mnt/data ext4 defaults 0 0" >> /etc/fstab
mount -a  # 生效配置
```

### 2. LVM 扩展（扩容）
当LV空间不足时，可从VG的剩余容量中扩容，**无需卸载**（ext4/xfs支持在线扩容）。
#### 步骤1：扩展逻辑卷（LV）
将 `lv_data` 扩容到20GB（增加10GB）：
```bash
# 方法1：增加指定容量
lvextend -L +10G /dev/vg_data/lv_data

# 方法2：扩容到指定总容量
lvextend -L 20G /dev/vg_data/lv_data
```

#### 步骤2：扩展文件系统
LV扩容后，需同步文件系统的容量：
```bash
# ext4文件系统
resize2fs /dev/vg_data/lv_data

# xfs文件系统
xfs_growfs /mnt/data  # xfs需指定挂载点
```

### 3. LVM 缩减（缩容）
**缩容有风险**，需先卸载分区，且文件系统实际占用空间需小于缩容后的容量。
#### 步骤1：卸载分区并检查文件系统
```bash
umount /mnt/data
e2fsck -f /dev/vg_data/lv_data  # 强制检查ext4文件系统，确保无错误
```

#### 步骤2：缩减文件系统
将文件系统缩减到8GB：
```bash
resize2fs /dev/vg_data/lv_data 8G
```

#### 步骤3：缩减逻辑卷（LV）
将LV缩减到8GB：
```bash
lvreduce -L 8G /dev/vg_data/lv_data
```

#### 步骤4：重新挂载
```bash
mount /dev/vg_data/lv_data /mnt/data
```

## 三、 RAID 阵列配置
RAID（独立磁盘冗余阵列）通过多块磁盘组合，提升存储的**性能**或**可靠性**，常见级别有 **RAID0、RAID1、RAID5、RAID10**。
- **RAID0**：条带化，无冗余，性能最高，一块盘损坏则全部数据丢失。
- **RAID1**：镜像，100%冗余，容量=单盘大小，可靠性最高。
- **RAID5**：分布式奇偶校验，至少3块盘，容量=(n-1)*单盘大小，允许1块盘损坏。
- **RAID10**：RAID1+RAID0，至少4块盘，兼顾性能和可靠性，允许每组镜像坏1块盘。

### 1. 软RAID 配置（mdadm）
Linux下用 `mdadm` 实现软件RAID，无需硬件RAID卡。
#### 步骤1：安装mdadm
```bash
yum install mdadm -y  # CentOS/RHEL
apt install mdadm -y  # Ubuntu/Debian
```

#### 步骤2：创建RAID5（以3块盘为例）
使用 `/dev/sdb`、`/dev/sdc`、`/dev/sdd` 三块盘创建RAID5，设备名 `/dev/md0`：
```bash
mdadm --create /dev/md0 --level=5 --raid-devices=3 /dev/sdb /dev/sdc /dev/sdd
# --level：RAID级别；--raid-devices：成员盘数量
```

#### 步骤3：查看RAID状态
```bash
mdadm --detail /dev/md0  # 查看详细信息
cat /proc/mdstat  # 查看RAID同步进度
```

#### 步骤4：格式化与挂载
```bash
mkfs.ext4 /dev/md0
mkdir /mnt/raid5
mount /dev/md0 /mnt/raid5

# 永久挂载
echo "/dev/md0 /mnt/raid5 ext4 defaults 0 0" >> /etc/fstab
```

#### 步骤5：RAID 故障处理
当某块盘损坏（如 `/dev/sdb`），标记为故障并移除：
```bash
mdadm /dev/md0 --fail /dev/sdb --remove /dev/sdb
```
插入新盘 `/dev/sdb`，添加到RAID并同步：
```bash
mdadm /dev/md0 --add /dev/sdb
```

## 四、 NFS 共享存储
NFS（Network File System）是Linux/Unix系统间的文件共享协议，可将服务端的目录共享给客户端，客户端挂载后像本地目录一样使用。

### 1. NFS 服务端配置
#### 步骤1：安装NFS服务
```bash
yum install nfs-utils rpcbind -y  # CentOS/RHEL
apt install nfs-kernel-server rpcbind -y  # Ubuntu/Debian
```

#### 步骤2：创建共享目录
```bash
mkdir /data/nfs_share
chmod 777 /data/nfs_share  # 赋予权限
```

#### 步骤3：配置共享权限（/etc/exports）
编辑配置文件，指定共享目录、允许访问的客户端及权限：
```bash
vim /etc/exports
# 添加如下内容（示例）
/data/nfs_share  192.168.1.0/24(rw,sync,no_root_squash,no_all_squash)
```
参数说明：
| 参数 | 作用 |
|------|------|
| `rw` | 读写权限 |
| `ro` | 只读权限 |
| `sync` | 同步写入，数据安全 |
| `async` | 异步写入，性能高 |
| `no_root_squash` | 客户端root用户映射为服务端root |
| `root_squash` | 客户端root映射为匿名用户（默认） |

#### 步骤4：启动服务并生效配置
```bash
# 启动rpcbind和nfs
systemctl start rpcbind
systemctl start nfs-server
systemctl enable rpcbind nfs-server  # 开机自启

# 生效exports配置
exportfs -rv
```

#### 步骤5：查看共享目录
```bash
showmount -e localhost  # 查看本地共享
```

### 2. NFS 客户端配置
#### 步骤1：安装客户端工具
```bash
yum install nfs-utils rpcbind -y  # CentOS/RHEL
apt install nfs-common rpcbind -y  # Ubuntu/Debian
```

#### 步骤2：查看服务端共享
```bash
showmount -e 192.168.1.100  # 替换为服务端IP
```

#### 步骤3：挂载共享目录
```bash
mkdir /mnt/nfs_client
mount -t nfs 192.168.1.100:/data/nfs_share /mnt/nfs_client

# 永久挂载
echo "192.168.1.100:/data/nfs_share /mnt/nfs_client nfs defaults 0 0" >> /etc/fstab
mount -a
```

#### 步骤4：验证挂载
```bash
df -h  # 查看挂载状态
touch /mnt/nfs_client/test.txt  # 在客户端创建文件，服务端查看是否同步
```

## 五、 常见问题与注意事项
1. **LVM 缩容前必须卸载分区**，且文件系统检查无错误，否则会导致数据丢失。
2. **RAID5 至少需要3块盘**，RAID10至少需要4块盘，且成员盘容量尽量一致。
3. **NFS 依赖rpcbind服务**，防火墙需放行 `nfs(2049)`、`rpcbind(111)` 端口。
4. **GPT分区表需用gdisk**，MBR分区表用fdisk，混用会导致分区表识别异常。

---

是否需要我为你整理**LVM+RAID+NFS 整合实战的步骤清单**，把这三个技术串联起来搭建一个可扩展的共享存储系统？

