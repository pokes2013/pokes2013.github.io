

# Linux 服务器安全配置全教程（iptables/firewalld+SSH加固+SELinux）

> 知识点：
>
> - iptables/firewalld 规则配置（端口开放、访问控制）
> - SSH 安全加固（禁用 root 登录、密钥认证）
> - SELinux 配置

## 说明
本文包含 **CentOS 7/8/9 通用** 的完整安全配置，涵盖「防火墙端口开放&访问控制」「SSH极致安全加固」「SELinux安全策略配置」，所有命令均为生产环境可用，按步骤执行即可，**优先级建议：firewalld > iptables**（firewalld是centos7+默认防火墙，动态防火墙，更易用、推荐优先使用）。

---

## 一、防火墙规则配置（端口开放+访问控制）
### ✅ 方式一：firewalld 防火墙配置（推荐，CentOS7+ 默认，必学）
#### 1. 基础状态管理（先确认运行状态）
```bash
# 查看firewalld运行状态（active(running)为正常运行）
systemctl status firewalld

# 开机自启（重要，防止重启失效）
systemctl enable firewalld

# 启动/重启/关闭 防火墙
systemctl start firewalld
systemctl restart firewalld
systemctl stop firewalld
```

#### 2. 核心操作 - 开放指定端口（TCP/UDP，永久生效）
firewalld 所有规则默认**临时生效**，添加 `--permanent` 为**永久生效**，**修改规则后必须 reload 才会生效**，不会断网！
```bash
# 格式1：开放TCP指定端口（最常用，如SSH-22、HTTP-80、HTTPS-443、MySQL-3306）
firewall-cmd --permanent --add-port=端口号/tcp

# 格式2：开放UDP指定端口（如DNS-53、NTP-123）
firewall-cmd --permanent --add-port=端口号/udp

# 格式3：开放连续端口段
firewall-cmd --permanent --add-port=1000-2000/tcp

# ✅ 示例：开放常用端口（生产环境必开）
firewall-cmd --permanent --add-port=22/tcp   # SSH远程连接
firewall-cmd --permanent --add-port=80/tcp   # HTTP网页
firewall-cmd --permanent --add-port=443/tcp  # HTTPS加密网页
firewall-cmd --permanent --add-port=3306/tcp # MySQL数据库
```

#### 3. 核心操作 - 关闭/移除指定开放端口
```bash
# 格式：移除指定端口规则（永久生效）
firewall-cmd --permanent --remove-port=端口号/tcp

# 示例：关闭MySQL的3306端口
firewall-cmd --permanent --remove-port=3306/tcp
```

#### 4. 核心操作 - 访问控制（IP黑白名单，精准管控来源）
##### ✔️ 方式A：允许【指定IP/IP段】访问本机（白名单，推荐）
```bash
# 1. 允许单个IP访问本机所有端口（如只允许运维IP 192.168.1.100连接服务器）
firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="192.168.1.100" accept"

# 2. 允许单个IP访问本机指定端口（精细化管控，生产首选！如只允许192.168.1.100连SSH-22）
firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="192.168.1.100" port protocol="tcp" port="22" accept"

# 3. 允许整个网段访问指定端口（如允许192.168.1.0/24内网段访问80端口）
firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="192.168.1.0/24" port protocol="tcp" port="80" accept"
```

##### ✔️ 方式B：拒绝【指定IP/IP段】访问本机（黑名单）
```bash
# 拒绝单个IP访问所有端口
firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="10.0.0.5" reject"

# 拒绝指定网段访问指定端口（如拒绝172.16.0.0/16访问3306）
firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="172.16.0.0/16" port protocol="tcp" port="3306" reject"
```

#### 5. 生效规则 & 查看规则（重中之重）
> ⚠️ 所有 `--permanent` 永久规则，**必须执行 reload 才能生效**，`reload` 是平滑重载，不会断开现有连接（如SSH），放心执行！
```bash
# 平滑重载规则，使配置生效（必执行）
firewall-cmd --reload

# 查看所有已生效的永久规则（确认配置是否生效）
firewall-cmd --permanent --list-all

# 快速查看开放的所有端口
firewall-cmd --permanent --list-ports
```

---

### ✅ 方式二：iptables 防火墙配置（CentOS6默认，CentOS7+兼容）
iptables 是静态防火墙，规则直接生效，无「临时/永久」之分，**重启后规则丢失**，生产环境需额外保存规则，适合老系统使用。
#### 1. 安装 & 状态管理
```bash
# CentOS7+ 安装iptables
yum install iptables-services -y

# 停止firewalld（二选一，避免冲突）
systemctl stop firewalld && systemctl disable firewalld

# 启动iptables并开机自启
systemctl start iptables && systemctl enable iptables
```

#### 2. 核心规则配置（端口开放+访问控制）
```bash
# 1. 开放指定端口（如22、80、443）
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# 2. 允许指定IP访问指定端口（如允许192.168.1.100访问22端口）
iptables -A INPUT -s 192.168.1.100 -p tcp --dport 22 -j ACCEPT

# 3. 拒绝指定IP访问所有端口（如拒绝10.0.0.5连接服务器）
iptables -A INPUT -s 10.0.0.5 -j DROP

# 4. 拒绝指定IP访问指定端口（如拒绝172.16.0.0/16访问3306）
iptables -A INPUT -s 172.16.0.0/16 -p tcp --dport 3306 -j DROP
```

#### 3. 保存规则 & 查看规则（防止重启丢失）
```bash
# 查看当前所有iptables规则
iptables -L -n

# 保存规则（CentOS7+，保存到配置文件，重启生效）
service iptables save

# 重启iptables生效
systemctl restart iptables
```

---

## 二、SSH 服务极致安全加固（重中之重，生产必做）
SSH 是服务器远程连接的核心入口，**90%的服务器入侵都是通过SSH暴力破解**，加固内容包含：**禁用root直接登录**、**启用密钥认证（替代密码登录）**、**禁用密码登录**、**修改默认端口（可选）**，按顺序执行，**绝对安全**！
> ✅ 所有配置修改的文件均为：`/etc/ssh/sshd_config`，修改后必须重启sshd服务生效。

### ✔️ 前置：编辑SSH核心配置文件
```bash
# 编辑配置文件（推荐vim，也可用nano）
vim /etc/ssh/sshd_config
```

### ✔️ 加固1：禁用 root 用户直接SSH登录（核心必做）
在配置文件中找到对应配置项，修改为如下值（没有则手动添加）：
```ini
# 禁止root用户直接登录，只能用普通用户登录后su/ssh到root
PermitRootLogin no
```

### ✔️ 加固2：启用 SSH 密钥认证（免密登录+极高安全性，替代密码）
密钥认证原理：**本地生成 公钥+私钥**，公钥上传到服务器，私钥保存在本地，登录时服务器验证本地私钥，无需输入密码，且暴力破解无法攻破，**生产环境必须开启**！
#### 步骤1：本地客户端生成密钥对（Windows/Mac/Linux通用）
```bash
# 本地终端执行（无需登录服务器），一路回车即可，默认生成在 ~/.ssh/ 目录
ssh-keygen -t rsa
```
执行完成后，本地会生成2个文件：
- `id_rsa` ：私钥，**核心机密，绝对不能泄露、不能传输**，保存在本地即可
- `id_rsa.pub` ：公钥，**可以随意传输**，需要上传到服务器

#### 步骤2：将本地公钥上传到服务器（2种方式，任选其一）
```bash
# 方式1：ssh-copy-id 一键上传（推荐，简单快捷）
# 格式：ssh-copy-id 服务器普通用户名@服务器IP
ssh-copy-id testuser@192.168.1.200

# 方式2：手动上传（如果方式1失败，用此方法）
# 1. 本地查看公钥内容并复制
cat ~/.ssh/id_rsa.pub
# 2. 登录服务器，创建目录并写入公钥
mkdir -p /home/testuser/.ssh && chmod 700 /home/testuser/.ssh
echo "你的公钥内容" >> /home/testuser/.ssh/authorized_keys
chmod 600 /home/testuser/.ssh/authorized_keys
```

#### 步骤3：服务器开启密钥认证（配置文件修改）
在 `/etc/ssh/sshd_config` 中修改：
```ini
# 启用密钥认证
PubkeyAuthentication yes
# 允许基于密钥的登录
AuthorizedKeysFile      .ssh/authorized_keys .ssh/authorized_keys2
```

### ✔️ 加固3：禁用 SSH 密码登录（终极加固，必做）
> ⚠️ 【重要前置】：**必须先完成「密钥认证配置」并测试登录成功后**，再禁用密码登录！否则会导致无法登录服务器！
测试密钥登录成功：本地执行 `ssh 普通用户名@服务器IP`，无需输入密码即可登录，说明配置成功。

然后在 `/etc/ssh/sshd_config` 中修改：
```ini
# 禁用密码登录，彻底杜绝暴力破解密码
PasswordAuthentication no
```

### ✔️ 加固4：SSH 其他安全优化（可选，推荐添加）
```ini
# 禁用空密码登录
PermitEmptyPasswords no
# 限制SSH连接超时时间，防止僵尸连接
ClientAliveInterval 60
ClientAliveCountMax 3
# 限制单个IP的并发连接数
MaxStartups 5:30:10
```

### ✔️ 最后：重启SSH服务，使所有配置生效
```bash
# CentOS7+ 重启sshd（平滑重启，不会断开现有连接）
systemctl restart sshd

# 验证sshd状态是否正常
systemctl status sshd
```

### ✔️ 验证加固效果
1. 尝试用root用户登录：`ssh root@服务器IP` → 提示拒绝登录 ✔️
2. 尝试用密码登录：`ssh testuser@服务器IP` → 提示密码认证失败 ✔️
3. 尝试用密钥登录：`ssh testuser@服务器IP` → 免密登录成功 ✔️

---

## 三、SELinux 安全策略配置（核心安全组件，必开！）
### ✅ 什么是 SELinux？
SELinux = **Security Enhanced Linux**，是Linux内核级的强制访问控制（MAC）安全机制，**CentOS 默认安装并启用**，作用是：**在Linux权限(rwx)基础上，增加一层更严格的访问控制**，即使黑客拿到root权限，也无法随意访问/修改文件，能有效防止提权、入侵、病毒等，**生产环境绝对不能关闭SELinux**！

### ✅ SELinux 三种运行模式（必须熟记）
```bash
# 查看当前SELinux运行模式（核心命令）
getenforce
# 或查看详细状态
sestatus
```
返回值对应三种模式，优先级从低到高：
1. **Disabled 禁用**：关闭SELinux，无任何安全防护，❌ 绝对不推荐
2. **Permissive 宽容模式**：开启SELinux，但**只告警不阻止**违规操作，适合调试排错，⚠️ 调试完成后必须改为Enforcing
3. **Enforcing 强制模式**：开启SELinux，**强制拦截**所有违规操作，✅ 生产环境唯一推荐模式！

### ✔️ 配置1：临时切换SELinux模式（立即生效，重启失效）
```bash
# 临时切换为强制模式（生产推荐，立即生效）
setenforce 1

# 临时切换为宽容模式（仅调试用）
setenforce 0
```

### ✔️ 配置2：永久修改SELinux模式（重启生效，核心配置）
临时切换重启后会恢复，需要修改配置文件永久生效，**生产环境必须配置为 enforcing**：
```bash
# 编辑SELinux主配置文件
vim /etc/selinux/config
```
修改核心配置项 `SELINUX` 的值，其他默认即可：
```ini
# 永久开启强制模式（生产必配）
SELINUX=enforcing
# 禁止自动设置为宽容模式
SELINUXTYPE=targeted
```
修改完成后，**重启服务器生效**：`reboot`

### ✔️ 配置3：SELinux 开放端口（核心场景）
> ⚠️ 重点：**防火墙(firewalld/iptables)开放端口 ≠ SELinux开放端口**！
Linux的端口访问有两层管控：
1. 第一层：防火墙（网络层），控制「外部能否访问端口」
2. 第二层：SELinux（系统层），控制「本机服务能否监听端口」

如果只在防火墙开放了端口，SELinux未授权，服务会启动失败或端口无法访问！**最常见场景：MySQL、Nginx、Tomcat等自定义端口**。

#### 核心命令：semanage 管理SELinux端口规则
```bash
# 先安装依赖包（默认没有semanage命令）
yum install policycoreutils-python-utils -y

# 1. 查看SELinux已授权的端口（如SSH-22、HTTP-80等默认已授权）
semanage port -l

# 2. 新增SELinux端口授权（永久生效，核心命令）
# 格式：semanage port -a -t 端口类型 -p tcp 端口号
# 常用端口类型：ssh_port_t(SSH)、http_port_t(web)、mysql_port_t(MySQL)
semanage port -a -t mysql_port_t -p tcp 3306
semanage port -a -t http_port_t -p tcp 8080

# 3. 删除已授权的端口
semanage port -d -t mysql_port_t -p tcp 3306
```

### ✔️ 配置4：SELinux 文件上下文配置（解决权限拒绝）
SELinux会给每个文件/目录打上「安全上下文」标签，只有对应服务的标签才能访问，**常见问题**：服务启动提示 `Permission denied`，但Linux权限(rwx)正常，就是SELinux上下文问题。
```bash
# 查看文件/目录的SELinux上下文
ls -Z /var/www/html

# 给目录添加正确的上下文（如web服务的html目录）
chcon -R -t httpd_sys_content_t /var/www/html

# 永久生效上下文（推荐）
semanage fcontext -a -t httpd_sys_content_t "/var/www/html(/.*/)"
restorecon -R /var/www/html
```

### ✔️ 常见误区纠正
> ❌ 错误做法：遇到SELinux相关报错，直接关闭SELinux
> ✅ 正确做法：SELinux是服务器的最后一道安全防线，**禁止关闭**，遇到报错先排查规则/上下文，再调整配置即可。

---

## 四、所有配置快速生效命令汇总
```bash
# firewalld规则生效
firewall-cmd --reload

# iptables规则生效
service iptables save && systemctl restart iptables

# SSH配置生效
systemctl restart sshd

# SELinux永久配置生效（需重启）
reboot
```

---

## ✅ 总结
1. 防火墙：**优先用firewalld**，规则永久生效+平滑重载，端口开放用`--add-port`，访问控制用`rich-rule`；
2. SSH加固：**禁用root登录+密钥认证+禁用密码登录**，三步缺一不可，是服务器防入侵的核心；
3. SELinux：**必须开启Enforcing模式**，防火墙是网络层防护，SELinux是内核层防护，二者结合才是完整的安全体系；
4. 生产原则：最小权限原则，只开放必须的端口，只允许必须的IP访问，禁用所有非必要的登录方式。

所有配置均为生产环境最优配置，按本文执行后，服务器的基础安全等级会大幅提升！